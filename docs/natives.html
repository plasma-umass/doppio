<!DOCTYPE html>

<html>
<head>
  <title>natives.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="frontend.html">
                frontend.coffee
              </a>
            
              
              <a class="source" href="node.html">
                node.coffee
              </a>
            
              
              <a class="source" href="untar.html">
                untar.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
              
              <a class="source" href="ClassData.html">
                ClassData.coffee
              </a>
            
              
              <a class="source" href="ClassLoader.html">
                ClassLoader.coffee
              </a>
            
              
              <a class="source" href="ConstantPool.html">
                ConstantPool.coffee
              </a>
            
              
              <a class="source" href="attributes.html">
                attributes.coffee
              </a>
            
              
              <a class="source" href="disassembler.html">
                disassembler.coffee
              </a>
            
              
              <a class="source" href="exceptions.html">
                exceptions.coffee
              </a>
            
              
              <a class="source" href="java_object.html">
                java_object.coffee
              </a>
            
              
              <a class="source" href="jvm.html">
                jvm.coffee
              </a>
            
              
              <a class="source" href="logging.html">
                logging.coffee
              </a>
            
              
              <a class="source" href="methods.html">
                methods.coffee
              </a>
            
              
              <a class="source" href="natives.html">
                natives.coffee
              </a>
            
              
              <a class="source" href="opcodes.html">
                opcodes.coffee
              </a>
            
              
              <a class="source" href="runtime.html">
                runtime.coffee
              </a>
            
              
              <a class="source" href="testing.html">
                testing.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>natives.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>pull in external modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>_ = require <span class="string">'../vendor/_.js'</span>
gLong = require <span class="string">'../vendor/gLong.js'</span>
util = require <span class="string">'./util'</span>
runtime = require <span class="string">'./runtime'</span>
{thread_name,JavaObject,JavaArray} = require <span class="string">'./java_object'</span>
exceptions = require <span class="string">'./exceptions'</span>
{log,debug,error,trace} = require <span class="string">'./logging'</span>
path = node?.path ? require <span class="string">'path'</span>
fs = node?.fs ? require <span class="string">'fs'</span>
{ReferenceClassData,PrimitiveClassData,ArrayClassData} = require <span class="string">'./ClassData'</span>

<span class="string">"use strict"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>things assigned to root will be available outside this module</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root = exports ? <span class="keyword">this</span>.natives = {}

<span class="keyword">if</span> node?  <span class="comment"># node is only defined if we're in the browser</span>
  vendor_path = <span class="string">'/home/doppio/vendor'</span>
<span class="keyword">else</span>
  vendor_path = path.resolve __dirname, <span class="string">'../vendor'</span>

system_properties = {
  <span class="string">'java.home'</span>: <span class="string">"<span class="subst">#{vendor_path}</span>/java_home"</span>,
  <span class="string">'sun.boot.class.path'</span>: <span class="string">"<span class="subst">#{vendor_path}</span>/classes"</span>,
  <span class="string">'file.encoding'</span>:<span class="string">'UTF-8'</span>,<span class="string">'java.vendor'</span>:<span class="string">'Doppio'</span>,
  <span class="string">'java.version'</span>: <span class="string">'1.6'</span>, <span class="string">'java.vendor.url'</span>: <span class="string">'https://github.com/int3/doppio'</span>,
  <span class="string">'java.class.version'</span>: <span class="string">'50.0'</span>,
  <span class="string">'java.specification.version'</span>: <span class="string">'1.6'</span>,
  <span class="string">'line.separator'</span>:<span class="string">'\n'</span>, <span class="string">'file.separator'</span>:<span class="string">'/'</span>, <span class="string">'path.separator'</span>:<span class="string">':'</span>,
  <span class="string">'user.dir'</span>: path.resolve(<span class="string">'.'</span>),<span class="string">'user.home'</span>:<span class="string">'.'</span>,<span class="string">'user.name'</span>:<span class="string">'DoppioUser'</span>,
  <span class="string">'os.name'</span>:<span class="string">'doppio'</span>, <span class="string">'os.arch'</span>: <span class="string">'js'</span>, <span class="string">'os.version'</span>: <span class="string">'0'</span>,
  <span class="string">'java.awt.headless'</span>: (<span class="keyword">not</span> node?).toString(),  <span class="comment"># true if we're using the console frontend</span>
  <span class="string">'java.awt.graphicsenv'</span>: <span class="string">'classes.awt.CanvasGraphicsEnvironment'</span>,
  <span class="string">'useJavaUtilZip'</span>: <span class="string">'true'</span>  <span class="comment"># hack for sun6javac, avoid ZipFileIndex shenanigans</span>
}

<span class="function"><span class="title">get_property</span></span> = (rs, jvm_key, _<span class="reserved">default</span> = <span class="literal">null</span>) -&gt;
  key = jvm_key.jvm2js_str()</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>XXX: mega hack, please make this better</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> key == <span class="string">'java.class.path'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>jvm is already defined in release mode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    classpath = jvm?.classpath ? require(<span class="string">'./jvm'</span>).classpath</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>the last path is actually the bootclasspath (vendor/classes/)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> rs.init_string classpath[<span class="number">0.</span>..classpath.length-<span class="number">1</span>].join <span class="string">':'</span>
  val = system_properties[key]
  <span class="keyword">if</span> val? <span class="keyword">then</span> rs.init_string(val, <span class="literal">true</span>) <span class="keyword">else</span> _<span class="reserved">default</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>convenience function. idea taken from coffeescript&#39;s grammar</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">o</span></span> = (fn_name, fn) -&gt; fn_name: fn_name, fn: fn

trapped_methods =
  java:
    lang:
      ref:
        Reference: [
          o <span class="string">'&lt;clinit&gt;()V'</span>, (rs) -&gt; <span class="comment"># NOP, because we don't do our own GC and also this starts a thread?!?!?!</span>
        ]
      String: [</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>trapped here only for speed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          o <span class="string">'hashCode()I'</span>, (rs, _<span class="keyword">this</span>) -&gt;
              hash = _<span class="keyword">this</span>.get_field rs, <span class="string">'Ljava/lang/String;hash'</span>
              <span class="keyword">if</span> hash <span class="keyword">is</span> <span class="number">0</span>
                offset = _<span class="keyword">this</span>.get_field rs, <span class="string">'Ljava/lang/String;offset'</span>
                chars = _<span class="keyword">this</span>.get_field(rs, <span class="string">'Ljava/lang/String;value'</span>).array
                count = _<span class="keyword">this</span>.get_field rs, <span class="string">'Ljava/lang/String;count'</span>
                <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..count] <span class="keyword">by</span> <span class="number">1</span>
                  hash = (hash * <span class="number">31</span> + chars[offset++]) | <span class="number">0</span>
                _<span class="keyword">this</span>.set_field rs, <span class="string">'Ljava/lang/String;hash'</span>, hash
              hash
      ]
      System: [
        o <span class="string">'loadLibrary(L!/!/String;)V'</span>, (rs) -&gt; <span class="comment"># NOP, because we don't support loading external libraries</span>
        o <span class="string">'adjustPropertiesForBackwardCompatibility(L!/util/Properties;)V'</span>, (rs) -&gt; <span class="comment"># NOP (apple-java specific)</span>
        o <span class="string">'getProperty(L!/!/String;)L!/!/String;'</span>, get_property
        o <span class="string">'getProperty(L!/!/String;L!/!/String;)L!/!/String;'</span>, get_property
      ]
      Terminator: [
        o <span class="string">'setup()V'</span>, (rs) -&gt; <span class="comment"># NOP, because we don't support threads</span>
      ]
    util:
      concurrent:
        atomic:
          AtomicInteger: [
            o <span class="string">'&lt;clinit&gt;()V'</span>, (rs) -&gt; <span class="comment">#NOP</span>
            o <span class="string">'compareAndSet(II)Z'</span>, (rs, _<span class="keyword">this</span>, expect, update) -&gt;
                _<span class="keyword">this</span>.set_field rs, <span class="string">'Ljava/util/concurrent/atomic/AtomicInteger;value'</span>, update  <span class="comment"># we don't need to compare, just set</span>
                <span class="literal">true</span> <span class="comment"># always true, because we only have one thread</span>
          ]
    nio:
      Bits: [
        o <span class="string">'byteOrder()L!/!/ByteOrder;'</span>, (rs) -&gt;
            cls = rs.get_bs_class(<span class="string">'Ljava/nio/ByteOrder;'</span>)
            cls.static_get rs, <span class="string">'LITTLE_ENDIAN'</span>
        o <span class="string">'copyToByteArray(JLjava/lang/Object;JJ)V'</span>, (rs, srcAddr, dst, dstPos, length) -&gt;
          unsafe_memcpy rs, <span class="literal">null</span>, srcAddr, dst, dstPos, length
      ]
      charset:
        Charset$<span class="number">3</span>: [</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>this is trapped and NOP&#39;ed for speed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          o <span class="string">'run()L!/lang/Object;'</span>, (rs) -&gt; <span class="literal">null</span>
        ]

<span class="function"><span class="title">doPrivileged</span></span> = (rs, action) -&gt;
  my_sf = rs.curr_frame()
  m = action.cls.method_lookup(rs, {class: action.cls.get_type(), sig: <span class="string">'run()Ljava/lang/Object;'</span>})
  rs.push action <span class="keyword">unless</span> m.access_flags.static
  m.setup_stack(rs)
  my_sf.<span class="function"><span class="title">runner</span></span> = -&gt;
    rv = rs.pop()
    rs.meta_stack().pop()
    rs.push rv
  <span class="keyword">throw</span> exceptions.ReturnException

<span class="function"><span class="title">stat_fd</span></span> = (fd) -&gt;
  <span class="keyword">try</span>
    <span class="keyword">return</span> fs.fstatSync fd
  <span class="keyword">catch</span> e
    <span class="keyword">return</span> <span class="literal">null</span>

<span class="function"><span class="title">stat_file</span></span> = (fname, cb) -&gt;
  fs.stat fname, (err, stat) -&gt;
    <span class="keyword">if</span> err?
      cb <span class="literal">null</span>
    <span class="keyword">else</span>
      cb stat</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>&quot;Fast&quot; array copy; does not have to check every element for illegal
assignments. You can do tricks here (if possible) to copy chunks of the array
at a time rather than element-by-element.
This function <em>cannot</em> access any attribute other than &#39;array&#39; on src due to
the special case when src == dest (see code for System.arraycopy below).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">arraycopy_no_check</span></span> = (src, src_pos, dest, dest_pos, length) -&gt;
  j = dest_pos
  <span class="keyword">for</span> i <span class="keyword">in</span> [src_pos...src_pos+length] <span class="keyword">by</span> <span class="number">1</span>
    dest.array[j++] = src.array[i]</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>CoffeeScript, we are not returning an array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>&quot;Slow&quot; array copy; has to check every element for illegal assignments.
You cannot do any tricks here; you must copy element by element until you
have either copied everything, or encountered an element that cannot be
assigned (which causes an exception).
Guarantees: src and dest are two different reference types. They cannot be
            primitive arrays.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">arraycopy_check</span></span> = (rs, src, src_pos, dest, dest_pos, length) -&gt;
  j = dest_pos
  dest_comp_cls = dest.cls.get_component_class()
  <span class="keyword">for</span> i <span class="keyword">in</span> [src_pos...src_pos+length] <span class="keyword">by</span> <span class="number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Check if null or castable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> src.array[i] == <span class="literal">null</span> <span class="keyword">or</span> src.array[i].cls.is_castable dest_comp_cls
      dest.array[j] = src.array[i]
    <span class="keyword">else</span>
      rs.java_throw rs.get_bs_class(<span class="string">'Ljava/lang/ArrayStoreException;'</span>), <span class="string">'Array element in src cannot be cast to dest array type.'</span>
    j++</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>CoffeeScript, we are not returning an array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">return</span>

<span class="function"><span class="title">unsafe_memcpy</span></span> = (rs, src_base, src_offset, dest_base, dest_offset, num_bytes) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>XXX assumes base object is an array if non-null
TODO: optimize by copying chunks at a time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  num_bytes = num_bytes.toNumber()
  <span class="keyword">if</span> src_base?
    src_offset = src_offset.toNumber()
    <span class="keyword">if</span> dest_base?</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>both are java arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      arraycopy_no_check(src_base, src_offset, dest_base, dest_offset.toNumber(), num_bytes)
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>src is an array, dest is a mem block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      dest_addr = rs.block_addr(dest_offset)
      <span class="keyword">if</span> DataView?
        <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..num_bytes] <span class="keyword">by</span> <span class="number">1</span>
          rs.mem_blocks[dest_addr].setInt8(i, src_base.array[src_offset+i])
      <span class="keyword">else</span>
        <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..num_bytes] <span class="keyword">by</span> <span class="number">1</span>
          rs.mem_blocks[dest_addr+i] = src_base.array[src_offset+i]
  <span class="keyword">else</span>
    src_addr = rs.block_addr(src_offset)
    <span class="keyword">if</span> dest_base?</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>src is a mem block, dest is an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      dest_offset = dest_offset.toNumber()
      <span class="keyword">if</span> DataView?
        <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..num_bytes] <span class="keyword">by</span> <span class="number">1</span>
          dest_base.array[dest_offset+i] = rs.mem_blocks[src_addr].getInt8(i)
      <span class="keyword">else</span>
        <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..num_bytes] <span class="keyword">by</span> <span class="number">1</span>
          dest_base.array[dest_offset+i] = rs.mem_blocks[src_addr+i]
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>both are mem blocks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      dest_addr = rs.block_addr(dest_offset)
      <span class="keyword">if</span> DataView?
        <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..num_bytes] <span class="keyword">by</span> <span class="number">1</span>
          rs.mem_blocks[dest_addr].setInt8(i, rs.mem_blocks[src_addr].getInt8(i))
      <span class="keyword">else</span>
        <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..num_bytes] <span class="keyword">by</span> <span class="number">1</span>
          rs.mem_blocks[dest_addr+i] = rs.mem_blocks[src_addr+i]

<span class="function"><span class="title">unsafe_compare_and_swap</span></span> = (rs, _<span class="keyword">this</span>, obj, offset, expected, x) -&gt;
  actual = obj.get_field_from_offset rs, offset
  <span class="keyword">if</span> actual == expected
    obj.set_field_from_offset rs, offset, x
    <span class="literal">true</span>
  <span class="keyword">else</span>
    <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>avoid code dup among native methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">native_define_class</span></span> = (rs, name, bytes, offset, len, loader, resume_cb, except_cb) -&gt;
  raw_bytes = ((<span class="number">256</span>+b)%<span class="number">256</span> <span class="keyword">for</span> b <span class="keyword">in</span> bytes.array[offset...offset+len])  <span class="comment"># convert to raw bytes</span>
  loader.define_class rs, util.int_classname(name.jvm2js_str()), raw_bytes, ((cdata)-&gt;resume_cb(cdata.get_class_object(rs))), except_cb

<span class="function"><span class="title">write_to_file</span></span> = (rs, _<span class="keyword">this</span>, bytes, offset, len, append) -&gt;
  rs.java_throw rs.get_bs_class(<span class="string">'Ljava/io/IOException;'</span>), <span class="string">"Bad file descriptor"</span> <span class="keyword">if</span> _<span class="keyword">this</span>.$file == <span class="string">'closed'</span>
  <span class="keyword">if</span> _<span class="keyword">this</span>.$file?</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>appends by default in the browser, not sure in actual node.js impl</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fs.writeSync(_<span class="keyword">this</span>.$file, <span class="keyword">new</span> Buffer(bytes.array), offset, len)
    <span class="keyword">return</span>
  rs.print util.chars2js_str(bytes, offset, len)
  <span class="keyword">if</span> node?</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>For the browser implementation -- the DOM doesn&#39;t get repainted
unless we give the event loop a chance to spin.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    rs.async_op (cb) -&gt; cb()</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Have a JavaClassLoaderObject and need its ClassLoader object? Use this method!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">get_cl_from_jclo</span></span> = (rs, jclo) -&gt; <span class="keyword">if</span> jclo? <span class="keyword">and</span> jclo.$loader? <span class="keyword">then</span> jclo.$loader <span class="keyword">else</span> rs.get_bs_cl()</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>helper function for stack trace natives (see java/lang/Throwable)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">create_stack_trace</span></span> = (rs, throwable) -&gt;
  stacktrace = []</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>we don&#39;t want to include the stack frames that were created by
the construction of this exception</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  cstack = rs.meta_stack()._cs.slice(<span class="number">1</span>,-<span class="number">1</span>)
  <span class="keyword">for</span> sf <span class="keyword">in</span> cstack <span class="keyword">when</span> <span class="keyword">not</span> (sf.<span class="reserved">native</span> <span class="keyword">or</span> sf.locals[<span class="number">0</span>] <span class="keyword">is</span> throwable)
    cls = sf.method.cls
    ln = -<span class="number">1</span>
    <span class="keyword">unless</span> throwable.cls.get_type() <span class="keyword">is</span> <span class="string">'Ljava/lang/NoClassDefFoundError;'</span>
      <span class="keyword">if</span> sf.method.access_flags.<span class="reserved">native</span>
        source_file = <span class="string">'Native Method'</span>
      <span class="keyword">else</span>
        source_file = cls.get_attribute(<span class="string">'SourceFile'</span>)?.filename <span class="keyword">or</span> <span class="string">'unknown'</span>
        table = sf.method.code?.get_attribute <span class="string">'LineNumberTable'</span>
        <span class="keyword">break</span> <span class="keyword">unless</span> table?</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>get the last line number before the stack frame&#39;s pc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">for</span> i,row <span class="keyword">of</span> table.entries <span class="keyword">when</span> row.start_pc &lt;= sf.pc
          ln = row.line_number
    <span class="keyword">else</span>
      source_file = <span class="string">'unknown'</span>
    stacktrace.push <span class="keyword">new</span> JavaObject rs, rs.get_bs_class(<span class="string">'Ljava/lang/StackTraceElement;'</span>), {
      <span class="string">'Ljava/lang/StackTraceElement;declaringClass'</span>: rs.init_string util.ext_classname cls.get_type()
      <span class="string">'Ljava/lang/StackTraceElement;methodName'</span>: rs.init_string(sf.method.name ? <span class="string">'unknown'</span>)
      <span class="string">'Ljava/lang/StackTraceElement;fileName'</span>: rs.init_string source_file
      <span class="string">'Ljava/lang/StackTraceElement;lineNumber'</span>: ln
    }
  <span class="keyword">return</span> stacktrace.reverse()

native_methods =
  java:
    lang:
      Class: [
        o <span class="string">'getPrimitiveClass(L!/!/String;)L!/!/!;'</span>, (rs, jvm_str) -&gt;
            type_desc = util.typestr2descriptor jvm_str.jvm2js_str()
            prim_cls = rs.get_bs_class type_desc
            <span class="keyword">return</span> prim_cls.get_class_object(rs)
        o <span class="string">'getClassLoader0()L!/!/ClassLoader;'</span>, (rs, _<span class="keyword">this</span>) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>The bootstrap classloader is represented as &#39;null&#39;, which is OK
according to the spec.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            loader = _<span class="keyword">this</span>.$cls.loader
            <span class="keyword">return</span> loader.loader_obj <span class="keyword">if</span> loader.loader_obj?
            <span class="keyword">return</span> <span class="literal">null</span>
        o <span class="string">'desiredAssertionStatus0(L!/!/!;)Z'</span>, (rs) -&gt; <span class="literal">false</span> <span class="comment"># we don't need no stinkin asserts</span>
        o <span class="string">'getName0()L!/!/String;'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            rs.init_string(_<span class="keyword">this</span>.$cls.toExternalString())
        o <span class="string">'forName0(L!/!/String;ZL!/!/ClassLoader;)L!/!/!;'</span>, (rs, jvm_str, initialize, loader) -&gt;
            type = util.int_classname jvm_str.jvm2js_str()
            loader = get_cl_from_jclo rs, loader
            rs.async_op (resume_cb, except_cb) -&gt;
              <span class="keyword">if</span> initialize
                loader.initialize_class rs, type, ((cls) -&gt;
                  resume_cb cls.get_class_object(rs)
                ), except_cb, <span class="literal">true</span>
              <span class="keyword">else</span>
                loader.resolve_class rs, type, ((cls) -&gt;
                  resume_cb cls.get_class_object(rs)
                ), except_cb, <span class="literal">true</span>
            <span class="keyword">return</span>
        o <span class="string">'getComponentType()L!/!/!;'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            <span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">unless</span> (_<span class="keyword">this</span>.$cls <span class="keyword">instanceof</span> ArrayClassData)</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>As this array type is loaded, the component type is guaranteed
to be loaded as well. No need for asynchronicity.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> _<span class="keyword">this</span>.$cls.get_component_class().get_class_object(rs)
        o <span class="string">'getGenericSignature()Ljava/lang/String;'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            sig = _<span class="keyword">this</span>.$cls.get_attribute(<span class="string">'Signature'</span>)?.sig
            <span class="keyword">if</span> sig? <span class="keyword">then</span> rs.init_string sig <span class="keyword">else</span> <span class="literal">null</span>
        o <span class="string">'getProtectionDomain0()Ljava/security/ProtectionDomain;'</span>, (rs, _<span class="keyword">this</span>) -&gt; <span class="literal">null</span>
        o <span class="string">'isAssignableFrom(L!/!/!;)Z'</span>, (rs, _<span class="keyword">this</span>, cls) -&gt;
            cls.$cls.is_castable _<span class="keyword">this</span>.$cls
        o <span class="string">'isInterface()Z'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">unless</span> _<span class="keyword">this</span>.$cls <span class="keyword">instanceof</span> ReferenceClassData
            _<span class="keyword">this</span>.$cls.access_flags.interface
        o <span class="string">'isInstance(L!/!/Object;)Z'</span>, (rs, _<span class="keyword">this</span>, obj) -&gt;
            obj.cls.is_castable _<span class="keyword">this</span>.$cls
        o <span class="string">'isPrimitive()Z'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            _<span class="keyword">this</span>.$cls <span class="keyword">instanceof</span> PrimitiveClassData
        o <span class="string">'isArray()Z'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            _<span class="keyword">this</span>.$cls <span class="keyword">instanceof</span> ArrayClassData
        o <span class="string">'getSuperclass()L!/!/!;'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            <span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">if</span> _<span class="keyword">this</span>.$cls <span class="keyword">instanceof</span> PrimitiveClassData
            cls = _<span class="keyword">this</span>.$cls
            <span class="keyword">if</span> cls.access_flags.interface <span class="keyword">or</span> <span class="keyword">not</span> cls.get_super_class()?
              <span class="keyword">return</span> <span class="literal">null</span>
            <span class="keyword">return</span> cls.get_super_class().get_class_object(rs)
        o <span class="string">'getDeclaredFields0(Z)[Ljava/lang/reflect/Field;'</span>, (rs, _<span class="keyword">this</span>, public_only) -&gt;
            fields = _<span class="keyword">this</span>.$cls.get_fields()
            fields = (f <span class="keyword">for</span> f <span class="keyword">in</span> fields <span class="keyword">when</span> f.access_flags.public) <span class="keyword">if</span> public_only
            base_array = []
            rs.async_op (resume_cb, except_cb) -&gt;
              i = -<span class="number">1</span>
              fetch_next_field = () -&gt;
                i++
                <span class="keyword">if</span> i &lt; fields.length
                  f = fields[i]
                  f.reflector(rs, ((jco)-&gt;base_array.push(jco); fetch_next_field()), except_cb)
                <span class="keyword">else</span>
                  resume_cb <span class="keyword">new</span> JavaArray(rs, rs.get_bs_class(<span class="string">'[Ljava/lang/reflect/Field;'</span>), base_array)

              fetch_next_field()
            <span class="keyword">return</span>
        o <span class="string">'getDeclaredMethods0(Z)[Ljava/lang/reflect/Method;'</span>, (rs, _<span class="keyword">this</span>, public_only) -&gt;
            methods = _<span class="keyword">this</span>.$cls.get_methods()
            methods = (m <span class="keyword">for</span> sig, m <span class="keyword">of</span> methods <span class="keyword">when</span> sig[<span class="number">0</span>] != <span class="string">'&lt;'</span> <span class="keyword">and</span> (m.access_flags.public <span class="keyword">or</span> <span class="keyword">not</span> public_only))

            base_array = []
            rs.async_op (resume_cb, except_cb) -&gt;
              i = -<span class="number">1</span>
              fetch_next_method = () -&gt;
                i++
                <span class="keyword">if</span> i &lt; methods.length
                  m = methods[i]
                  m.reflector(rs, <span class="literal">false</span>, ((jco)-&gt;base_array.push(jco); fetch_next_method()), except_cb)
                <span class="keyword">else</span>
                  resume_cb <span class="keyword">new</span> JavaArray(rs, rs.get_bs_class(<span class="string">'[Ljava/lang/reflect/Method;'</span>), base_array)

              fetch_next_method()
            <span class="keyword">return</span>
        o <span class="string">'getDeclaredConstructors0(Z)[Ljava/lang/reflect/Constructor;'</span>, (rs, _<span class="keyword">this</span>, public_only) -&gt;
            methods = _<span class="keyword">this</span>.$cls.get_methods()
            methods = (m <span class="keyword">for</span> sig, m <span class="keyword">of</span> methods <span class="keyword">when</span> m.name <span class="keyword">is</span> <span class="string">'&lt;init&gt;'</span>)
            methods = (m <span class="keyword">for</span> m <span class="keyword">in</span> methods <span class="keyword">when</span> m.access_flags.public) <span class="keyword">if</span> public_only
            ctor_array_cdata = rs.get_bs_class(<span class="string">'[Ljava/lang/reflect/Constructor;'</span>)
            base_array = []
            rs.async_op (resume_cb, except_cb) -&gt;
              i = -<span class="number">1</span>
              fetch_next_method = () -&gt;
                i++
                <span class="keyword">if</span> i &lt; methods.length
                  m = methods[i]
                  m.reflector(rs, <span class="literal">true</span>, ((jco)-&gt;base_array.push(jco); fetch_next_method()), except_cb)
                <span class="keyword">else</span>
                  resume_cb <span class="keyword">new</span> JavaArray(rs, ctor_array_cdata, base_array)

              fetch_next_method()
            <span class="keyword">return</span>
        o <span class="string">'getInterfaces()[L!/!/!;'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            cls = _<span class="keyword">this</span>.$cls
            ifaces = cls.get_interfaces()
            iface_objs = (iface.get_class_object(rs) <span class="keyword">for</span> iface <span class="keyword">in</span> ifaces)
            <span class="keyword">new</span> JavaArray rs, rs.get_bs_class(<span class="string">'[Ljava/lang/Class;'</span>), iface_objs
        o <span class="string">'getModifiers()I'</span>, (rs, _<span class="keyword">this</span>) -&gt; _<span class="keyword">this</span>.$cls.access_byte
        o <span class="string">'getRawAnnotations()[B'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            cls = _<span class="keyword">this</span>.$cls
            annotations = cls.get_attribute <span class="string">'RuntimeVisibleAnnotations'</span>
            <span class="keyword">return</span> <span class="keyword">new</span> JavaArray rs, rs.get_bs_class(<span class="string">'[B'</span>), annotations.raw_bytes <span class="keyword">if</span> annotations?
            <span class="keyword">for</span> sig,m <span class="keyword">of</span> cls.get_methods()
              annotations = m.get_attribute <span class="string">'RuntimeVisibleAnnotations'</span>
              <span class="keyword">return</span> <span class="keyword">new</span> JavaArray rs, rs.get_bs_class(<span class="string">'[B'</span>), annotations.raw_bytes <span class="keyword">if</span> annotations?
            <span class="literal">null</span>
        o <span class="string">'getConstantPool()Lsun/reflect/ConstantPool;'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            cls = _<span class="keyword">this</span>.$cls
            <span class="keyword">new</span> JavaObject rs, rs.get_bs_class(<span class="string">'Lsun/reflect/ConstantPool;'</span>), {<span class="string">'Lsun/reflect/ConstantPool;constantPoolOop'</span>: cls.constant_pool}
        o <span class="string">'getEnclosingMethod0()[L!/!/Object;'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            <span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">unless</span> _<span class="keyword">this</span>.$cls <span class="keyword">instanceof</span> ReferenceClassData
            cls = _<span class="keyword">this</span>.$cls
            em = cls.get_attribute <span class="string">'EnclosingMethod'</span>
            <span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">unless</span> em?
            rs.java_throw rs.get_bs_class(<span class="string">'Ljava/lang/Error;'</span>), <span class="string">"native method not finished: java.lang.Class.getEnclosingClass"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>TODO: return array w/ 3 elements:
- the immediately enclosing class (java/lang/Class)
- the immediately enclosing method or constructor&#39;s name (can be null). (String)
- the immediately enclosing method or constructor&#39;s descriptor (null iff name is). (String)
new JavaArray rs, rs.class_lookup(&#39;[Ljava/lang/Object;&#39;), [null,null,null]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        o <span class="string">'getDeclaringClass()L!/!/!;'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            <span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">unless</span> _<span class="keyword">this</span>.$cls <span class="keyword">instanceof</span> ReferenceClassData
            cls = _<span class="keyword">this</span>.$cls
            icls = cls.get_attribute <span class="string">'InnerClasses'</span>
            <span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">unless</span> icls?
            my_class = _<span class="keyword">this</span>.$cls.get_type()
            <span class="keyword">for</span> entry <span class="keyword">in</span> icls.classes <span class="keyword">when</span> entry.outer_info_index &gt; <span class="number">0</span>
              name = cls.constant_pool.get(entry.inner_info_index).deref()
              <span class="keyword">continue</span> <span class="keyword">unless</span> name <span class="keyword">is</span> my_class</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>XXX(jez): this assumes that the first enclosing entry is also
the immediate enclosing parent, and I&#39;m not 100% sure this is
guaranteed by the spec</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              declaring_name = cls.constant_pool.get(entry.outer_info_index).deref()
              <span class="keyword">return</span> cls.loader.get_initialized_class(declaring_name).get_class_object(rs)
            <span class="keyword">return</span> <span class="literal">null</span>
        o <span class="string">'getDeclaredClasses0()[L!/!/!;'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            ret = <span class="keyword">new</span> JavaArray rs, rs.get_bs_class(<span class="string">'[Ljava/lang/Class;'</span>), []
            <span class="keyword">return</span> ret <span class="keyword">unless</span> _<span class="keyword">this</span>.$cls <span class="keyword">instanceof</span> ReferenceClassData
            cls = _<span class="keyword">this</span>.$cls
            my_class = _<span class="keyword">this</span>.$cls.get_type()
            iclses = cls.get_attributes <span class="string">'InnerClasses'</span>
            <span class="keyword">return</span> ret <span class="keyword">if</span> iclses.length <span class="keyword">is</span> <span class="number">0</span>
            flat_names = []
            <span class="keyword">for</span> icls <span class="keyword">in</span> iclses
              <span class="keyword">for</span> c <span class="keyword">in</span> icls.classes <span class="keyword">when</span> c.outer_info_index &gt; <span class="number">0</span>
                enclosing_name = cls.constant_pool.get(c.outer_info_index).deref()
                <span class="keyword">continue</span> <span class="keyword">unless</span> enclosing_name <span class="keyword">is</span> my_class
                flat_names.push cls.constant_pool.get(c.inner_info_index).deref()
            rs.async_op (resume_cb, except_cb) -&gt;
              i = -<span class="number">1</span>
              fetch_next_jco = () -&gt;
                i++
                <span class="keyword">if</span> i &lt; flat_names.length
                  name = flat_names[i]
                  cls.loader.resolve_class(rs, name, ((cls)-&gt;ret.array.push cls.get_class_object(rs); fetch_next_jco()), except_cb)
                <span class="keyword">else</span>
                  resume_cb ret
              fetch_next_jco()
            <span class="keyword">return</span>
      ],</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Fun Note: The bootstrap classloader object is represented by null.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      ClassLoader: [
        o <span class="string">'findLoadedClass0(L!/!/String;)L!/!/Class;'</span>, (rs, _<span class="keyword">this</span>, name) -&gt;
            loader = get_cl_from_jclo rs, _<span class="keyword">this</span>
            type = util.int_classname name.jvm2js_str()</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Return JavaClassObject if loaded, or null otherwise.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            cls = loader.get_resolved_class type, <span class="literal">true</span>
            <span class="keyword">return</span> <span class="keyword">if</span> cls? <span class="keyword">then</span> cls.get_class_object(rs) <span class="keyword">else</span> <span class="literal">null</span>
        o <span class="string">'findBootstrapClass(L!/!/String;)L!/!/Class;'</span>, (rs, _<span class="keyword">this</span>, name) -&gt;
            type = util.int_classname name.jvm2js_str()</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>This returns null in OpenJDK7, but actually can throw an exception
in OpenJDK6.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            rs.async_op (resume_cb, except_cb) -&gt;
              rs.get_bs_cl().resolve_class rs, type, ((cls)-&gt;
                resume_cb cls.get_class_object(rs)
              ), except_cb, <span class="literal">true</span>
        o <span class="string">'getCaller(I)L!/!/Class;'</span>, (rs, i) -&gt;
            cls = rs.meta_stack().get_caller(i).method.cls
            <span class="keyword">return</span> cls.get_class_object(rs)
        o <span class="string">'defineClass1(L!/!/String;[BIIL!/security/ProtectionDomain;L!/!/String;Z)L!/!/Class;'</span>, (rs,_<span class="keyword">this</span>,name,bytes,offset,len,pd,source,unused) -&gt;
            loader = get_cl_from_jclo rs, _<span class="keyword">this</span>
            rs.async_op (resume_cb, except_cb) -&gt;
              native_define_class rs, name, bytes, offset, len, loader, resume_cb, except_cb
        o <span class="string">'defineClass1(L!/!/String;[BIIL!/security/ProtectionDomain;L!/!/String;)L!/!/Class;'</span>, (rs,_<span class="keyword">this</span>,name,bytes,offset,len,pd,source) -&gt;
            loader = get_cl_from_jclo rs, _<span class="keyword">this</span>
            rs.async_op (resume_cb, except_cb) -&gt;
              native_define_class rs, name, bytes, offset, len, loader, resume_cb, except_cb
        o <span class="string">'resolveClass0(L!/!/Class;)V'</span>, (rs, _<span class="keyword">this</span>, cls) -&gt;
            loader = get_cl_from_jclo rs, _<span class="keyword">this</span>
            type = cls.$cls.get_type()
            <span class="keyword">return</span> <span class="keyword">if</span> loader.get_resolved_class(type, <span class="literal">true</span>)?</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Ensure that this class is resolved.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            rs.async_op (resume_cb, except_cb) -&gt;
              loader.resolve_class rs, type, (()-&gt;resume_cb()), except_cb, <span class="literal">true</span>
      ],
      Compiler: [
        o <span class="string">'disable()V'</span>, (rs, _<span class="keyword">this</span>) -&gt; <span class="comment">#NOP</span>
        o <span class="string">'enable()V'</span>, (rs, _<span class="keyword">this</span>) -&gt; <span class="comment">#NOP</span>
      ]
      Float: [
        o <span class="string">'floatToRawIntBits(F)I'</span>, (rs, f_val) -&gt;
            <span class="keyword">if</span> Float32Array?
              f_view = <span class="keyword">new</span> Float32Array [f_val]
              i_view = <span class="keyword">new</span> Int32Array f_view.buffer
              <span class="keyword">return</span> i_view[<span class="number">0</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Special cases!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">if</span> f_val <span class="keyword">is</span> <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>We map the infinities to JavaScript infinities. Map them back.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> util.FLOAT_POS_INFINITY_AS_INT <span class="keyword">if</span> f_val <span class="keyword">is</span> Number.POSITIVE_INFINITY
            <span class="keyword">return</span> util.FLOAT_NEG_INFINITY_AS_INT <span class="keyword">if</span> f_val <span class="keyword">is</span> Number.NEGATIVE_INFINITY</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Convert JavaScript NaN to Float NaN value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> util.FLOAT_NaN_AS_INT <span class="keyword">if</span> isNaN(f_val)</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>We have more bits of precision than a float, so below we round to
the nearest significand. This appears to be what the x86
Java does for normal floating point operations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            sign = <span class="keyword">if</span> f_val &lt; <span class="number">0</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span>
            f_val = Math.abs(f_val)</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Subnormal zone!
(1)^signbits2^1260.significandbits
Largest subnormal magnitude:
0000 0000 0111 1111 1111 1111 1111 1111
Smallest subnormal magnitude:
0000 0000 0000 0000 0000 0000 0000 0001</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> f_val &lt;= <span class="number">1.1754942106924411e-38</span> <span class="keyword">and</span> f_val &gt;= <span class="number">1.4012984643248170e-45</span>
              exp = <span class="number">0</span>
              sig = Math.round((f_val/Math.pow(<span class="number">2</span>,-<span class="number">126</span>))*Math.pow(<span class="number">2</span>,<span class="number">23</span>))
              <span class="keyword">return</span> (sign&lt;&lt;<span class="number">31</span>)|(exp&lt;&lt;<span class="number">23</span>)|sig</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Regular FP numbers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">else</span>
              exp = Math.floor(Math.log(f_val)/Math.LN2)
              sig = Math.round((f_val/Math.pow(<span class="number">2</span>,exp)-<span class="number">1</span>)*Math.pow(<span class="number">2</span>,<span class="number">23</span>))
              <span class="keyword">return</span> (sign&lt;&lt;<span class="number">31</span>)|((exp+<span class="number">127</span>)&lt;&lt;<span class="number">23</span>)|sig
        o <span class="string">'intBitsToFloat(I)F'</span>, (rs, i_val) -&gt; util.intbits2float(i_val)
      ]
      Double: [
        o <span class="string">'doubleToRawLongBits(D)J'</span>, (rs, d_val) -&gt;
            <span class="keyword">if</span> Float64Array?
              d_view = <span class="keyword">new</span> Float64Array [d_val]
              i_view = <span class="keyword">new</span> Uint32Array d_view.buffer
              <span class="keyword">return</span> gLong.fromBits i_view[<span class="number">0</span>], i_view[<span class="number">1</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Fallback for older JS engines
Special cases</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> gLong.ZERO <span class="keyword">if</span> d_val <span class="keyword">is</span> <span class="number">0</span>
            <span class="keyword">if</span> d_val <span class="keyword">is</span> Number.POSITIVE_INFINITY</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>High bits: 0111 1111 1111 0000 0000 0000 0000 0000
 Low bits: 0000 0000 0000 0000 0000 0000 0000 0000</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="keyword">return</span> gLong.fromBits(<span class="number">0</span>, <span class="number">2146435072</span>)
            <span class="keyword">else</span> <span class="keyword">if</span> d_val <span class="keyword">is</span> Number.NEGATIVE_INFINITY</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>High bits: 1111 1111 1111 0000 0000 0000 0000 0000
 Low bits: 0000 0000 0000 0000 0000 0000 0000 0000</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="keyword">return</span> gLong.fromBits(<span class="number">0</span>, -<span class="number">1048576</span>)
            <span class="keyword">else</span> <span class="keyword">if</span> isNaN(d_val)</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>High bits: 0111 1111 1111 1000 0000 0000 0000 0000
 Low bits: 0000 0000 0000 0000 0000 0000 0000 0000</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="keyword">return</span> gLong.fromBits(<span class="number">0</span>, <span class="number">2146959360</span>)

            sign = <span class="keyword">if</span> d_val &lt; <span class="number">0</span> <span class="keyword">then</span> (<span class="number">1</span> &lt;&lt; <span class="number">31</span>) <span class="keyword">else</span> <span class="number">0</span>
            d_val = Math.abs(d_val)</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Check if it is a subnormal number.
(-1)s  0.f  2-1022
Largest subnormal magnitude:
0000 0000 0000 1111 1111 1111 1111 1111
1111 1111 1111 1111 1111 1111 1111 1111
Smallest subnormal magnitude:
0000 0000 0000 0000 0000 0000 0000 0000
0000 0000 0000 0000 0000 0000 0000 0001</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> d_val &lt;= <span class="number">2.2250738585072010e-308</span> <span class="keyword">and</span> d_val &gt;= <span class="number">5.0000000000000000e-324</span>
              exp = <span class="number">0</span>
              sig = gLong.fromNumber((d_val/Math.pow(<span class="number">2</span>,-<span class="number">1022</span>))*Math.pow(<span class="number">2</span>,<span class="number">52</span>))
            <span class="keyword">else</span>
              exp = Math.floor(Math.log(d_val)/Math.LN2)</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>If d_val is close to a power of two, there&#39;s a chance that exp
will be 1 greater than it should due to loss of accuracy in the
log result.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              exp = exp-<span class="number">1</span> <span class="keyword">if</span> d_val &lt; Math.pow(<span class="number">2</span>,exp)
              sig = gLong.fromNumber((d_val/Math.pow(<span class="number">2</span>,exp)-<span class="number">1</span>)*Math.pow(<span class="number">2</span>,<span class="number">52</span>))
              exp = (exp + <span class="number">1023</span>) &lt;&lt; <span class="number">20</span>

            high_bits = sig.getHighBits() | sign | exp

            gLong.fromBits(sig.getLowBits(), high_bits)
        o <span class="string">'longBitsToDouble(J)D'</span>, (rs, l_val) -&gt; util.longbits2double(l_val.getHighBits(), l_val.getLowBitsUnsigned())
      ]
      Object: [
        o <span class="string">'getClass()L!/!/Class;'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            <span class="keyword">return</span> _<span class="keyword">this</span>.cls.get_class_object(rs)
        o <span class="string">'hashCode()I'</span>, (rs, _<span class="keyword">this</span>) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>return the pseudo heap reference, essentially a unique id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            _<span class="keyword">this</span>.ref
        o <span class="string">'clone()L!/!/!;'</span>, (rs, _<span class="keyword">this</span>) -&gt; _<span class="keyword">this</span>.clone(rs)
        o <span class="string">'notify()V'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            debug <span class="string">"TE(notify): on lock *<span class="subst">#{_<span class="keyword">this</span>.ref}</span>"</span>
            <span class="keyword">if</span> (locker = rs.lock_refs[_<span class="keyword">this</span>])?
              <span class="keyword">if</span> locker <span class="keyword">isnt</span> rs.curr_thread
                owner = thread_name rs, locker
                rs.java_throw rs.get_bs_class(<span class="string">'Ljava/lang/IllegalMonitorStateException;'</span>), <span class="string">"Thread '<span class="subst">#{owner}</span>' owns this monitor"</span>
            <span class="keyword">if</span> rs.waiting_threads[_<span class="keyword">this</span>]?
              rs.waiting_threads[_<span class="keyword">this</span>].shift()
        o <span class="string">'notifyAll()V'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            debug <span class="string">"TE(notifyAll): on lock *<span class="subst">#{_<span class="keyword">this</span>.ref}</span>"</span>
            <span class="keyword">if</span> (locker = rs.lock_refs[_<span class="keyword">this</span>])?
              <span class="keyword">if</span> locker <span class="keyword">isnt</span> rs.curr_thread
                owner = thread_name rs, locker
                rs.java_throw rs.get_bs_class(<span class="string">'Ljava/lang/IllegalMonitorStateException;'</span>), <span class="string">"Thread '<span class="subst">#{owner}</span>' owns this monitor"</span>
            <span class="keyword">if</span> rs.waiting_threads[_<span class="keyword">this</span>]?
              rs.waiting_threads[_<span class="keyword">this</span>] = []
        o <span class="string">'wait(J)V'</span>, (rs, _<span class="keyword">this</span>, timeout) -&gt;
            <span class="keyword">unless</span> timeout <span class="keyword">is</span> gLong.ZERO
              error <span class="string">"TODO(Object::wait): respect the timeout param (<span class="subst">#{timeout}</span>)"</span>
            <span class="keyword">if</span> (locker = rs.lock_refs[_<span class="keyword">this</span>])?
              <span class="keyword">if</span> locker <span class="keyword">isnt</span> rs.curr_thread
                owner = thread_name rs, locker
                rs.java_throw rs.get_bs_class(<span class="string">'Ljava/lang/IllegalMonitorStateException;'</span>), <span class="string">"Thread '<span class="subst">#{owner}</span>' owns this monitor"</span>
            rs.lock_refs[_<span class="keyword">this</span>] = <span class="literal">null</span>
            rs.wait _<span class="keyword">this</span>
      ]
      Package: [
        o <span class="string">'getSystemPackage0(Ljava/lang/String;)Ljava/lang/String;'</span>, (rs) -&gt; <span class="literal">null</span>
      ]
      ProcessEnvironment: [
        o <span class="string">'environ()[[B'</span>, (rs) -&gt;
            env_arr = []</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>convert to an array of strings of the form [key, value, key, value ...]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">for</span> k, v <span class="keyword">of</span> process.env
              env_arr.push <span class="keyword">new</span> JavaArray rs, rs.get_bs_class(<span class="string">'[B'</span>), util.bytestr_to_array k
              env_arr.push <span class="keyword">new</span> JavaArray rs, rs.get_bs_class(<span class="string">'[B'</span>), util.bytestr_to_array v
            <span class="keyword">new</span> JavaArray rs, rs.get_bs_class(<span class="string">'[[B'</span>), env_arr
      ]
      reflect:
        Array: [
          o <span class="string">'newArray(L!/!/Class;I)L!/!/Object;'</span>, (rs, _<span class="keyword">this</span>, len) -&gt;
              rs.heap_newarray _<span class="keyword">this</span>.$cls.get_type(), len
          o <span class="string">'getLength(Ljava/lang/Object;)I'</span>, (rs, arr) -&gt;
              rs.check_null(arr).array.length
        ]
        Proxy: [
          o <span class="string">'defineClass0(L!/!/ClassLoader;L!/!/String;[BII)L!/!/Class;'</span>, (rs,cl,name,bytes,offset,len) -&gt;
              rs.async_op (success_cb, except_cb) -&gt;
                native_define_class rs, name, bytes, offset, len, get_cl_from_jclo(rs, cl), success_cb, except_cb
        ]
      Runtime: [
        o <span class="string">'availableProcessors()I'</span>, () -&gt; <span class="number">1</span>
        o <span class="string">'gc()V'</span>, (rs) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>No universal way of forcing browser to GC, so we yield in hopes
that the browser will use it as an opportunity to GC.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            rs.async_op (cb) -&gt; cb()
      ]
      SecurityManager: [
        o <span class="string">'getClassContext()[Ljava/lang/Class;'</span>, (rs, _<span class="keyword">this</span>) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>return an array of classes for each method on the stack
starting with the current method and going up the call chain</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            classes = []
            <span class="keyword">for</span> sf <span class="keyword">in</span> rs.meta_stack()._cs <span class="keyword">by</span> -<span class="number">1</span>  <span class="comment"># have to get at the internals</span>
              <span class="keyword">unless</span> sf.<span class="reserved">native</span>
                classes.push sf.method.cls.get_class_object(rs)
            <span class="keyword">new</span> JavaArray rs, rs.get_bs_class(<span class="string">'[Ljava/lang/Class;'</span>), classes
      ]
      Shutdown: [
        o <span class="string">'halt0(I)V'</span>, (rs, status) -&gt; <span class="keyword">throw</span> <span class="keyword">new</span> exceptions.HaltException(status)
      ]
      StrictMath: [
        o <span class="string">'acos(D)D'</span>, (rs, d_val) -&gt; Math.acos(d_val)
        o <span class="string">'asin(D)D'</span>, (rs, d_val) -&gt; Math.asin(d_val)
        o <span class="string">'atan(D)D'</span>, (rs, d_val) -&gt; Math.atan(d_val)
        o <span class="string">'atan2(DD)D'</span>, (rs, y, x) -&gt; Math.atan2(y, x)
        o <span class="string">'cos(D)D'</span>, (rs, d_val) -&gt; Math.cos(d_val)
        o <span class="string">'exp(D)D'</span>, (rs, d_val) -&gt; Math.exp(d_val)
        o <span class="string">'log(D)D'</span>, (rs, d_val) -&gt; Math.log(d_val)
        o <span class="string">'pow(DD)D'</span>, (rs, base, exp) -&gt; Math.pow(base, exp)
        o <span class="string">'sin(D)D'</span>, (rs, d_val) -&gt; Math.sin(d_val)
        o <span class="string">'sqrt(D)D'</span>, (rs, d_val) -&gt; Math.sqrt(d_val)
        o <span class="string">'tan(D)D'</span>, (rs, d_val) -&gt; Math.tan(d_val)</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>these two are native in OpenJDK but not Apple-Java</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        o <span class="string">'floor(D)D'</span>, (rs, d_val) -&gt; Math.floor(d_val)
        o <span class="string">'ceil(D)D'</span>, (rs, d_val) -&gt; Math.ceil(d_val)
      ]
      String: [
        o <span class="string">'intern()L!/!/!;'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            js_str = _<span class="keyword">this</span>.jvm2js_str()
            <span class="keyword">unless</span> (s = rs.string_pool.get(js_str))?
              s = rs.string_pool.set(js_str, _<span class="keyword">this</span>)
            s
      ]
      System: [
        o <span class="string">'arraycopy(L!/!/Object;IL!/!/Object;II)V'</span>, (rs, src, src_pos, dest, dest_pos, length) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Needs to be checked <em>even if length is 0</em>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> !src? <span class="keyword">or</span> !dest?
              rs.java_throw rs.get_bs_class(<span class="string">'Ljava/lang/NullPointerException;'</span>), <span class="string">'Cannot copy to/from a null array.'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Can&#39;t do this on non-array types. Need to check before I check bounds below, or else I&#39;ll get an exception.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> !(src.cls <span class="keyword">instanceof</span> ArrayClassData) <span class="keyword">or</span> !(dest.cls <span class="keyword">instanceof</span> ArrayClassData)
              rs.java_throw rs.get_bs_class(<span class="string">'Ljava/lang/ArrayStoreException;'</span>), <span class="string">'src and dest arguments must be of array type.'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Also needs to be checked <em>even if length is 0</em>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> src_pos &lt; <span class="number">0</span> <span class="keyword">or</span> (src_pos+length) &gt; src.array.length <span class="keyword">or</span> dest_pos &lt; <span class="number">0</span> <span class="keyword">or</span> (dest_pos+length) &gt; dest.array.length <span class="keyword">or</span> length &lt; <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>System.arraycopy requires IndexOutOfBoundsException, but Java throws an array variant of the exception in practice.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              rs.java_throw rs.get_bs_class(<span class="string">'Ljava/lang/ArrayIndexOutOfBoundsException;'</span>), <span class="string">'Tried to write to an illegal index in an array.'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Special case; need to copy the section of src that is being copied into a temporary array before actually doing the copy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> src == dest
              src = {cls: src.cls, array: src.array.slice(src_pos, src_pos+length)}
              src_pos = <span class="number">0</span>

            <span class="keyword">if</span> src.cls.is_castable dest.cls</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Fast path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              arraycopy_no_check(src, src_pos, dest, dest_pos, length)
            <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Slow path
Absolutely cannot do this when two different primitive types, or a primitive type and a reference type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              src_comp_cls = src.cls.get_component_class()
              dest_comp_cls = dest.cls.get_component_class()
              <span class="keyword">if</span> (src_comp_cls <span class="keyword">instanceof</span> PrimitiveClassData) <span class="keyword">or</span> (dest_comp_cls <span class="keyword">instanceof</span> PrimitiveClassData)
                rs.java_throw rs.get_bs_class(<span class="string">'Ljava/lang/ArrayStoreException;'</span>), <span class="string">'If calling arraycopy with a primitive array, both src and dest must be of the same primitive type.'</span>
              <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Must be two reference types.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                arraycopy_check(rs, src, src_pos, dest, dest_pos, length)
        o <span class="string">'currentTimeMillis()J'</span>, (rs) -&gt; gLong.fromNumber((<span class="keyword">new</span> Date).getTime())
        o <span class="string">'identityHashCode(L!/!/Object;)I'</span>, (rs, x) -&gt; x?.ref ? <span class="number">0</span>
        o <span class="string">'initProperties(L!/util/Properties;)L!/util/Properties;'</span>, (rs, props) -&gt; rs.push <span class="literal">null</span> <span class="comment"># return value should not be used</span>
        o <span class="string">'nanoTime()J'</span>, (rs) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>we don&#39;t actually have nanosecond precision</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            gLong.fromNumber((<span class="keyword">new</span> Date).getTime()).multiply(gLong.fromNumber(<span class="number">1000000</span>))
        o <span class="string">'setIn0(L!/io/InputStream;)V'</span>, (rs, stream) -&gt;
            sys = rs.get_bs_class <span class="string">'Ljava/lang/System;'</span>
            sys.static_put rs, <span class="string">'in'</span>, stream
        o <span class="string">'setOut0(L!/io/PrintStream;)V'</span>, (rs, stream) -&gt;
            sys = rs.get_bs_class <span class="string">'Ljava/lang/System;'</span>
            sys.static_put rs, <span class="string">'out'</span>, stream
        o <span class="string">'setErr0(L!/io/PrintStream;)V'</span>, (rs, stream) -&gt;
            sys = rs.get_bs_class <span class="string">'Ljava/lang/System;'</span>
            sys.static_put rs, <span class="string">'err'</span>, stream
      ]
      Thread: [
        o <span class="string">'currentThread()L!/!/!;'</span>, (rs) -&gt; rs.curr_thread
        o <span class="string">'setPriority0(I)V'</span>, (rs) -&gt; <span class="comment"># NOP</span>
        o <span class="string">'holdsLock(L!/!/Object;)Z'</span>, (rs, obj) -&gt; rs.curr_thread <span class="keyword">is</span> rs.lock_refs[obj]
        o <span class="string">'isAlive()Z'</span>, (rs, _<span class="keyword">this</span>) -&gt; _<span class="keyword">this</span>.$isAlive ? <span class="literal">false</span>
        o <span class="string">'isInterrupted(Z)Z'</span>, (rs, _<span class="keyword">this</span>, clear_flag) -&gt;
            tmp = _<span class="keyword">this</span>.$isInterrupted ? <span class="literal">false</span>
            _<span class="keyword">this</span>.$isInterrupted = <span class="literal">false</span> <span class="keyword">if</span> clear_flag
            tmp
        o <span class="string">'interrupt0()V'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            _<span class="keyword">this</span>.$isInterrupted = <span class="literal">true</span>
            <span class="keyword">return</span> <span class="keyword">if</span> _<span class="keyword">this</span> <span class="keyword">is</span> rs.curr_thread
            debug <span class="string">"TE(interrupt0): interrupting <span class="subst">#{thread_name rs, _<span class="keyword">this</span>}</span>"</span>
            new_thread_sf = util.last _<span class="keyword">this</span>.$meta_stack._cs
            new_thread_sf.<span class="function"><span class="title">runner</span></span> = -&gt;
              rs.java_throw rs.get_bs_class(<span class="string">'Ljava/lang/InterruptedException;'</span>), <span class="string">'interrupt0 called'</span>
            _<span class="keyword">this</span>.$meta_stack.push {}  <span class="comment"># dummy</span>
            rs.yield _<span class="keyword">this</span>
        o <span class="string">'start0()V'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            _<span class="keyword">this</span>.$isAlive = <span class="literal">true</span>
            _<span class="keyword">this</span>.$meta_stack = <span class="keyword">new</span> runtime.CallStack()
            rs.thread_pool.push _<span class="keyword">this</span>
            old_thread_sf = rs.curr_frame()
            debug <span class="string">"TE(start0): starting <span class="subst">#{thread_name rs, _<span class="keyword">this</span>}</span> from <span class="subst">#{thread_name rs, rs.curr_thread}</span>"</span>
            rs.curr_thread = _<span class="keyword">this</span>
            new_thread_sf = rs.curr_frame()
            rs.push _<span class="keyword">this</span>
            run_method = _<span class="keyword">this</span>.cls.method_lookup(rs, {class: _<span class="keyword">this</span>.cls.get_type(), sig: <span class="string">'run()V'</span>})
            thread_runner_sf = run_method.setup_stack(rs)
            new_thread_sf.<span class="function"><span class="title">runner</span></span> = -&gt;
              new_thread_sf.runner = <span class="literal">null</span>  <span class="comment"># new_thread_sf is the fake SF at index 0</span>
              _<span class="keyword">this</span>.$isAlive = <span class="literal">false</span>
              debug <span class="string">"TE(start0): thread died: <span class="subst">#{thread_name rs, _<span class="keyword">this</span>}</span>"</span>
            old_thread_sf.<span class="function"><span class="title">runner</span></span> = -&gt;
              debug <span class="string">"TE(start0): thread resumed: <span class="subst">#{thread_name rs, rs.curr_thread}</span>"</span>
              rs.meta_stack().pop()
            <span class="keyword">throw</span> exceptions.ReturnException
        o <span class="string">'sleep(J)V'</span>, (rs, millis) -&gt;
            rs.async_op (cb) -&gt; setTimeout(cb, millis.toNumber())
        o <span class="string">'yield()V'</span>, (rs, _<span class="keyword">this</span>) -&gt; rs.yield()
      ]
      Throwable: [
        o <span class="string">'fillInStackTrace()L!/!/!;'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            strace = <span class="keyword">new</span> JavaArray rs, rs.get_bs_class(<span class="string">'[Ljava/lang/StackTraceElement;'</span>), create_stack_trace(rs, _<span class="keyword">this</span>)
            _<span class="keyword">this</span>.set_field rs, <span class="string">'Ljava/lang/Throwable;stackTrace'</span>, strace
            _<span class="keyword">this</span>
        o <span class="string">'getStackTraceDepth()I'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            create_stack_trace(rs, _<span class="keyword">this</span>).length
        o <span class="string">'getStackTraceElement(I)L!/!/StackTraceElement;'</span>, (rs, _<span class="keyword">this</span>, depth) -&gt;
            create_stack_trace(rs, _<span class="keyword">this</span>)[depth]
      ]
    security:
      AccessController: [
        o <span class="string">'doPrivileged(L!/!/PrivilegedAction;)L!/lang/Object;'</span>, doPrivileged
        o <span class="string">'doPrivileged(L!/!/PrivilegedAction;L!/!/AccessControlContext;)L!/lang/Object;'</span>, doPrivileged
        o <span class="string">'doPrivileged(L!/!/PrivilegedExceptionAction;)L!/lang/Object;'</span>, doPrivileged
        o <span class="string">'doPrivileged(L!/!/PrivilegedExceptionAction;L!/!/AccessControlContext;)L!/lang/Object;'</span>, doPrivileged
        o <span class="string">'getStackAccessControlContext()Ljava/security/AccessControlContext;'</span>, (rs) -&gt; <span class="literal">null</span>
      ]
    io:
      Console: [
        o <span class="string">'encoding()L!/lang/String;'</span>, -&gt; <span class="literal">null</span>
        o <span class="string">'istty()Z'</span>, -&gt; <span class="literal">true</span>
      ]
      FileSystem: [
        o <span class="string">'getFileSystem()L!/!/!;'</span>, (rs) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>TODO: avoid making a new FS object each time this gets called? seems to happen naturally in java/io/File...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            my_sf = rs.curr_frame()
            cdata = rs.get_bs_class(<span class="string">'Ljava/io/ExpiringCache;'</span>)
            cache1 = <span class="keyword">new</span> JavaObject rs, cdata
            cache2 = <span class="keyword">new</span> JavaObject rs, cdata
            cache_init = cdata.method_lookup(rs, {class: <span class="string">'Ljava/io/ExpiringCache;'</span>, sig: <span class="string">'&lt;init&gt;()V'</span>})
            rs.push2 cache1, cache2
            cache_init.setup_stack(rs)
            my_sf.<span class="function"><span class="title">runner</span></span> = -&gt;
              cache_init.setup_stack(rs)
              my_sf.<span class="function"><span class="title">runner</span></span> = -&gt;
                rv = <span class="keyword">new</span> JavaObject rs, rs.get_bs_class(<span class="string">'Ljava/io/UnixFileSystem;'</span>), {
                  <span class="string">'Ljava/io/UnixFileSystem;cache'</span>: cache1
                  <span class="string">'Ljava/io/UnixFileSystem;javaHomePrefixCache'</span>: cache2
                  <span class="string">'Ljava/io/UnixFileSystem;slash'</span>: system_properties[<span class="string">'file.separator'</span>].charCodeAt(<span class="number">0</span>)
                  <span class="string">'Ljava/io/UnixFileSystem;colon'</span>: system_properties[<span class="string">'path.separator'</span>].charCodeAt(<span class="number">0</span>)
                  <span class="string">'Ljava/io/UnixFileSystem;javaHome'</span>: rs.init_string(system_properties[<span class="string">'java.home'</span>], <span class="literal">true</span>)
                }
                rs.meta_stack().pop()
                rs.push rv
            <span class="keyword">throw</span> exceptions.ReturnException
      ]
      FileOutputStream: [
        o <span class="string">'open(L!/lang/String;)V'</span>, (rs, _<span class="keyword">this</span>, fname) -&gt;
            rs.async_op (resume_cb) -&gt;
              fs.open fname.jvm2js_str(), <span class="string">'w'</span>, (err, f) -&gt;
                _<span class="keyword">this</span>.$file = f
                resume_cb()
        o <span class="string">'openAppend(Ljava/lang/String;)V'</span>, (rs, _<span class="keyword">this</span>, fname) -&gt;
            rs.async_op (resume_cb) -&gt;
              fs.open fname.jvm2js_str(), <span class="string">'a'</span>, (err, f) -&gt;
                _<span class="keyword">this</span>.$file = f
                resume_cb()
        o <span class="string">'writeBytes([BIIZ)V'</span>, write_to_file  <span class="comment"># OpenJDK version</span>
        o <span class="string">'writeBytes([BII)V'</span>, write_to_file   <span class="comment"># Apple-java version</span>
        o <span class="string">'close0()V'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            <span class="keyword">if</span> _<span class="keyword">this</span>.$file?
              rs.async_op (resume_cb) -&gt;
                fs.close _<span class="keyword">this</span>.$file, (err) -&gt;
                  _<span class="keyword">this</span>.$file = <span class="string">'closed'</span>
                  resume_cb()
      ]
      FileInputStream: [
        o <span class="string">'available()I'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            rs.java_throw rs.get_bs_class(<span class="string">'Ljava/io/IOException;'</span>), <span class="string">"Bad file descriptor"</span> <span class="keyword">if</span> _<span class="keyword">this</span>.$file == <span class="string">'closed'</span>
            <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">unless</span> _<span class="keyword">this</span>.$file? <span class="comment"># no buffering for stdin</span>
            stats = fs.fstatSync _<span class="keyword">this</span>.$file
            stats.size - _<span class="keyword">this</span>.$pos
        o <span class="string">'read()I'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            rs.java_throw rs.get_bs_class(<span class="string">'Ljava/io/IOException;'</span>), <span class="string">"Bad file descriptor"</span> <span class="keyword">if</span> _<span class="keyword">this</span>.$file == <span class="string">'closed'</span>
            <span class="keyword">if</span> (file = _<span class="keyword">this</span>.$file)?</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>this is a real file that we&#39;ve already opened</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              buf = <span class="keyword">new</span> Buffer((fs.fstatSync file).size)
              bytes_read = fs.readSync(file, buf, <span class="number">0</span>, <span class="number">1</span>, _<span class="keyword">this</span>.$pos)
              _<span class="keyword">this</span>.$pos++
              <span class="keyword">return</span> <span class="keyword">if</span> bytes_read == <span class="number">0</span> <span class="keyword">then</span> -<span class="number">1</span> <span class="keyword">else</span> buf.readUInt8(<span class="number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>reading from System.in, do it async</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            rs.async_op (cb) -&gt;
              rs.async_input <span class="number">1</span>, (byte) -&gt;
                cb(<span class="keyword">if</span> byte.length == <span class="number">0</span> <span class="keyword">then</span> -<span class="number">1</span> <span class="keyword">else</span> byte.charCodeAt(<span class="number">0</span>))
        o <span class="string">'readBytes([BII)I'</span>, (rs, _<span class="keyword">this</span>, byte_arr, offset, n_bytes) -&gt;
            rs.java_throw rs.get_bs_class(<span class="string">'Ljava/io/IOException;'</span>), <span class="string">"Bad file descriptor"</span> <span class="keyword">if</span> _<span class="keyword">this</span>.$file == <span class="string">'closed'</span>
            <span class="keyword">if</span> _<span class="keyword">this</span>.$file?</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>this is a real file that we&#39;ve already opened</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              pos = _<span class="keyword">this</span>.$pos
              file = _<span class="keyword">this</span>.$file
              buf = <span class="keyword">new</span> Buffer n_bytes</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>if at end of file, return -1.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              filesize = fs.fstatSync(file).size
              <span class="keyword">if</span> filesize &gt; <span class="number">0</span> <span class="keyword">and</span> pos &gt;= filesize-<span class="number">1</span>
                <span class="keyword">return</span> -<span class="number">1</span>
              bytes_read = fs.readSync(file, buf, <span class="number">0</span>, n_bytes, pos)</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>not clear why, but sometimes node doesn&#39;t move the file pointer,
so we do it here ourselves</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              _<span class="keyword">this</span>.$pos += bytes_read
              byte_arr.array[offset+i] = buf.readUInt8(i) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..bytes_read] <span class="keyword">by</span> <span class="number">1</span>
              <span class="keyword">return</span> <span class="keyword">if</span> bytes_read == <span class="number">0</span> <span class="keyword">and</span> n_bytes <span class="keyword">isnt</span> <span class="number">0</span> <span class="keyword">then</span> -<span class="number">1</span> <span class="keyword">else</span> bytes_read</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>reading from System.in, do it async</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            rs.async_op (cb) -&gt;
              rs.async_input n_bytes, (bytes) -&gt;
                byte_arr.array[offset+idx] = b <span class="keyword">for</span> b, idx <span class="keyword">in</span> bytes
                cb(bytes.length)
        o <span class="string">'open(Ljava/lang/String;)V'</span>, (rs, _<span class="keyword">this</span>, filename) -&gt;
            filepath = filename.jvm2js_str()</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>TODO: actually look at the mode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            rs.async_op (resume_cb, except_cb) -&gt;
              fs.open filepath, <span class="string">'r'</span>, (e, f) -&gt;
                <span class="keyword">if</span> e?
                  <span class="keyword">if</span> e.code == <span class="string">'ENOENT'</span>
                    except_cb ()-&gt; rs.java_throw rs.get_bs_class(<span class="string">'Ljava/io/FileNotFoundException;'</span>), <span class="string">"<span class="subst">#{filepath}</span> (No such file or directory)"</span>
                  <span class="keyword">else</span>
                    except_cb ()-&gt; <span class="keyword">throw</span> e
                <span class="keyword">else</span>
                  _<span class="keyword">this</span>.$file = f</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>also store the file handle in the file descriptor object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  fd = _<span class="keyword">this</span>.get_field rs, <span class="string">'Ljava/io/FileInputStream;fd'</span>
                  fd.set_field rs, <span class="string">'Ljava/io/FileDescriptor;fd'</span>, _<span class="keyword">this</span>.$file
                  _<span class="keyword">this</span>.$pos = <span class="number">0</span>
                  resume_cb()
        o <span class="string">'close0()V'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            <span class="keyword">if</span> _<span class="keyword">this</span>.$file?
              rs.async_op (resume_cb) -&gt;
                fs.close _<span class="keyword">this</span>.$file, (err) -&gt;
                  _<span class="keyword">this</span>.$file = <span class="string">'closed'</span>
                  resume_cb()
            <span class="keyword">else</span>
              _<span class="keyword">this</span>.$file = <span class="string">'closed'</span>
        o <span class="string">'skip(J)J'</span>, (rs, _<span class="keyword">this</span>, n_bytes) -&gt;
            rs.java_throw rs.get_bs_class(<span class="string">'Ljava/io/IOException;'</span>), <span class="string">"Bad file descriptor"</span> <span class="keyword">if</span> _<span class="keyword">this</span>.$file == <span class="string">'closed'</span>
            <span class="keyword">if</span> (file = _<span class="keyword">this</span>.$file)?
              bytes_left = fs.fstatSync(file).size - _<span class="keyword">this</span>.$pos
              to_skip = Math.min(n_bytes.toNumber(), bytes_left)
              _<span class="keyword">this</span>.$pos += to_skip
              <span class="keyword">return</span> gLong.fromNumber(to_skip)</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>reading from System.in, do it async</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            rs.async_op (cb) -&gt;
              rs.async_input n_bytes.toNumber(), (bytes) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>we don&#39;t care about what the input actually was</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                cb gLong.fromNumber(bytes.length), <span class="literal">null</span>
      ]
      ObjectInputStream: [
        o <span class="string">'latestUserDefinedLoader()Ljava/lang/ClassLoader;'</span>, (rs) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Returns the first non-null class loader (not counting class loaders
 of generated reflection implementation classes) up the execution stack,
 or null if only code from the null class loader is on the stack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="literal">null</span>  <span class="comment"># XXX: actually check for class loaders on the stack</span>
      ]
      ObjectStreamClass: [
        o <span class="string">'initNative()V'</span>, (rs) -&gt;  <span class="comment"># NOP</span>
        o <span class="string">'hasStaticInitializer(Ljava/lang/Class;)Z'</span>, (rs, cls) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>check if cls has a <clinit> method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> cls.$cls.get_method(<span class="string">'&lt;clinit&gt;()V'</span>)?
      ]
      RandomAccessFile: [
        o <span class="string">'open(Ljava/lang/String;I)V'</span>, (rs, _<span class="keyword">this</span>, filename, mode) -&gt;
            filepath = filename.jvm2js_str()</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>TODO: actually look at the mode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            rs.async_op (resume_cb, except_cb) -&gt;
              fs.open filepath, <span class="string">'r+'</span>, (err, f) -&gt;
                <span class="keyword">if</span> err?
                  <span class="keyword">if</span> e.code == <span class="string">'ENOENT'</span>
                    except_cb -&gt; rs.java_throw rs.get_bs_class(<span class="string">'Ljava/io/FileNotFoundException;'</span>), <span class="string">"Could not open file <span class="subst">#{filepath}</span>"</span>
                  <span class="keyword">else</span>
                    except_cb -&gt; <span class="keyword">throw</span> e
                <span class="keyword">else</span>
                  _<span class="keyword">this</span>.$file = f
                  _<span class="keyword">this</span>.$pos = <span class="number">0</span>
                  resume_cb()
        o <span class="string">'getFilePointer()J'</span>, (rs, _<span class="keyword">this</span>) -&gt; gLong.fromNumber _<span class="keyword">this</span>.$pos
        o <span class="string">'length()J'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            stats = stat_fd _<span class="keyword">this</span>.$file
            gLong.fromNumber stats.size
        o <span class="string">'seek(J)V'</span>, (rs, _<span class="keyword">this</span>, pos) -&gt; _<span class="keyword">this</span>.$pos = pos
        o <span class="string">'readBytes([BII)I'</span>, (rs, _<span class="keyword">this</span>, byte_arr, offset, len) -&gt;
            pos = _<span class="keyword">this</span>.$pos.toNumber()
            file = _<span class="keyword">this</span>.$file</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>if at end of file, return -1.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> pos &gt;= fs.fstatSync(file).size-<span class="number">1</span>
              <span class="keyword">return</span> -<span class="number">1</span>
            buf = <span class="keyword">new</span> Buffer len
            bytes_read = fs.readSync(file, buf, <span class="number">0</span>, len, pos)
            byte_arr.array[offset+i] = buf.readUInt8(i) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..bytes_read] <span class="keyword">by</span> <span class="number">1</span>
            _<span class="keyword">this</span>.$pos = gLong.fromNumber(pos+bytes_read)
            <span class="keyword">return</span> <span class="keyword">if</span> bytes_read == <span class="number">0</span> <span class="keyword">and</span> len <span class="keyword">isnt</span> <span class="number">0</span> <span class="keyword">then</span> -<span class="number">1</span> <span class="keyword">else</span> bytes_read
        o <span class="string">'writeBytes([BII)V'</span>, (rs, _<span class="keyword">this</span>, byte_arr, offset, len) -&gt;
            pos = _<span class="keyword">this</span>.$pos.toNumber()
            file = _<span class="keyword">this</span>.$file
            js_str = util.chars2js_str byte_arr, offset, len</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>uses the old string-based API
see <a href="http://stackoverflow.com/q/14367261/10601">http://stackoverflow.com/q/14367261/10601</a> for details</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            fs.writeSync(file, js_str, pos)
        o <span class="string">'close0()V'</span>, (rs, _<span class="keyword">this</span>) -&gt;
            rs.async_op (resume_cb) -&gt;
              fs.close _<span class="keyword">this</span>.$file, (-&gt;
                _<span class="keyword">this</span>.$file = <span class="literal">null</span>
                resume_cb()
              )
      ]
      UnixFileSystem: [
        o <span class="string">'canonicalize0(L!/lang/String;)L!/lang/String;'</span>, (rs, _<span class="keyword">this</span>, jvm_path_str) -&gt;
            js_str = jvm_path_str.jvm2js_str()
            rs.init_string path.resolve(path.normalize(js_str))
        o <span class="string">'checkAccess(Ljava/io/File;I)Z'</span>, (rs, _<span class="keyword">this</span>, file, access) -&gt;
            filepath = file.get_field rs, <span class="string">'Ljava/io/File;path'</span>
            rs.async_op (resume_cb) -&gt;
              stat_file filepath.jvm2js_str(), (stats) -&gt;
                <span class="keyword">unless</span> stats?
                  resume_cb <span class="literal">false</span>
                <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>XXX: Assuming we&#39;re owner/group/other. :)
Shift access so it&#39;s present in owner/group/other.
Then, AND with the actual mode, and check if the result is above 0.
That indicates that the access bit we&#39;re looking for was set on
one of owner/group/other.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  mask = access | (access &lt;&lt; <span class="number">3</span>) | (access &lt;&lt; <span class="number">6</span>)
                  resume_cb((stats.mode &amp; mask) &gt; <span class="number">0</span>)
        o <span class="string">'createDirectory(Ljava/io/File;)Z'</span>, (rs, _<span class="keyword">this</span>, file) -&gt;
            filepath = (file.get_field rs, <span class="string">'Ljava/io/File;path'</span>).jvm2js_str()</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Already exists.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            rs.async_op (resume_cb) -&gt;
              stat_file filepath, (stat) -&gt;
                <span class="keyword">if</span> stat?
                  resume_cb <span class="literal">false</span>
                <span class="keyword">else</span>
                  fs.mkdir filepath, (err) -&gt;
                    resume_cb(<span class="keyword">if</span> err? <span class="keyword">then</span> <span class="literal">false</span> <span class="keyword">else</span> <span class="literal">true</span>)
        o <span class="string">'createFileExclusively(Ljava/lang/String;)Z'</span>, (rs, _<span class="keyword">this</span>, path) -&gt;  <span class="comment"># OpenJDK version</span>
            filepath = path.jvm2js_str()
            rs.async_op (resume_cb, except_cb) -&gt;
              stat_file filepath, (stat) -&gt;
                <span class="keyword">if</span> stat?
                  resume_cb <span class="literal">false</span>
                <span class="keyword">else</span>
                  fs.open filepath, <span class="string">'w'</span>, (err, f) -&gt;
                    <span class="keyword">if</span> err?
                      except_cb -&gt; rs.java_throw rs.get_bs_class(<span class="string">'Ljava/io/IOException;'</span>), e.message
                    <span class="keyword">else</span>
                      fs.close f, (err) -&gt;
                        <span class="keyword">if</span> err?
                          except_cb -&gt; rs.java_throw rs.get_bs_class(<span class="string">'Ljava/io/IOException;'</span>), e.message
                        <span class="keyword">else</span>
                          resume_cb <span class="literal">true</span>
        o <span class="string">'createFileExclusively(Ljava/lang/String;Z)Z'</span>, (rs, _<span class="keyword">this</span>, path) -&gt;  <span class="comment"># Apple-java version</span>
            filepath = path.jvm2js_str()
            rs.async_op (resume_cb, except_cb) -&gt;
              stat_file filepath, (stat) -&gt;
                <span class="keyword">if</span> stat?
                  resume_cb <span class="literal">false</span>
                <span class="keyword">else</span>
                  fs.open filepath, <span class="string">'w'</span>, (err, f) -&gt;
                    <span class="keyword">if</span> err?
                      except_cb -&gt; rs.java_throw rs.get_bs_class(<span class="string">'Ljava/io/IOException;'</span>), e.message
                    <span class="keyword">else</span>
                      fs.close f, (err) -&gt;
                        <span class="keyword">if</span> err?
                          except_cb -&gt; rs.java_throw rs.get_bs_class(<span class="string">'Ljava/io/IOException;'</span>), e.message
                        <span class="keyword">else</span>
                          resume_cb <span class="literal">true</span>
        o <span class="string">'delete0(Ljava/io/File;)Z'</span>, (rs, _<span class="keyword">this</span>, file) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Delete the file or directory denoted by the given abstract
pathname, returning true if and only if the operation succeeds.
If file is a directory, it must be empty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            filepath = (file.get_field rs, <span class="string">'Ljava/io/File;path'</span>).jvm2js_str()
            rs.async_op (resume_cb, except_cb) -&gt;
              stat_file filepath, (stats) -&gt;
                <span class="keyword">unless</span> stats?
                  resume_cb <span class="literal">false</span>
                <span class="keyword">else</span> <span class="keyword">if</span> stats.isDirectory()
                  fs.readdir filepath, (err, files) -&gt;
                    <span class="keyword">if</span> files.length &gt; <span class="number">0</span>
                      resume_cb <span class="literal">false</span>
                    <span class="keyword">else</span>
                      fs.rmdir filepath, (err) -&gt;
                        resume_cb <span class="literal">true</span>
                <span class="keyword">else</span>
                  fs.unlink filepath, (err) -&gt;
                    resume_cb <span class="literal">true</span>
        o <span class="string">'getBooleanAttributes0(Ljava/io/File;)I'</span>, (rs, _<span class="keyword">this</span>, file) -&gt;
            filepath = file.get_field rs, <span class="string">'Ljava/io/File;path'</span>
            rs.async_op (resume_cb) -&gt;
              stat_file filepath.jvm2js_str(), (stats) -&gt;
                <span class="keyword">unless</span> stats?
                  resume_cb <span class="number">0</span>
                <span class="keyword">else</span> <span class="keyword">if</span> stats.isFile()
                  resume_cb <span class="number">3</span>
                <span class="keyword">else</span> <span class="keyword">if</span> stats.isDirectory()
                  resume_cb <span class="number">5</span>
                <span class="keyword">else</span>
                  resume_cb <span class="number">1</span>
        o <span class="string">'getLastModifiedTime(Ljava/io/File;)J'</span>, (rs, _<span class="keyword">this</span>, file) -&gt;
            filepath = file.get_field(rs, <span class="string">'Ljava/io/File;path'</span>).jvm2js_str()
            rs.async_op (resume_cb) -&gt;
              stat_file filepath, (stats) -&gt;
                <span class="keyword">unless</span> stats?
                  resume_cb gLong.ZERO, <span class="literal">null</span>
                <span class="keyword">else</span>
                  resume_cb gLong.fromNumber (<span class="keyword">new</span> Date(stats.mtime)).getTime(), <span class="literal">null</span>
        o <span class="string">'setLastModifiedTime(Ljava/io/File;J)Z'</span>, (rs, _<span class="keyword">this</span>, file, time) -&gt;
            mtime = time.toNumber()
            atime = (<span class="keyword">new</span> Date).getTime()
            filepath = file.get_field(rs, <span class="string">'Ljava/io/File;path'</span>).jvm2js_str()
            rs.async_op (resume_cb) -&gt;
              fs.utimes filepath, atime, mtime, (err) -&gt;
                resume_cb <span class="literal">true</span>
        o <span class="string">'getLength(Ljava/io/File;)J'</span>, (rs, _<span class="keyword">this</span>, file) -&gt;
            filepath = file.get_field rs, <span class="string">'Ljava/io/File;path'</span>
            rs.async_op (resume_cb) -&gt;
              fs.stat filepath.jvm2js_str(), (err, stat) -&gt;
                resume_cb gLong.fromNumber(<span class="keyword">if</span> err? <span class="keyword">then</span> <span class="number">0</span> <span class="keyword">else</span> stat.size), <span class="literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>o &#39;getSpace(Ljava/io/File;I)J&#39;, (rs, _this, file, t) -&gt;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        o <span class="string">'list(Ljava/io/File;)[Ljava/lang/String;'</span>, (rs, _<span class="keyword">this</span>, file) -&gt;
            filepath = file.get_field rs, <span class="string">'Ljava/io/File;path'</span>
            rs.async_op (resume_cb) -&gt;
              fs.readdir filepath.jvm2js_str(), (err, files) -&gt;
                <span class="keyword">if</span> err?
                  resume_cb <span class="literal">null</span>
                <span class="keyword">else</span>
                  resume_cb <span class="keyword">new</span> JavaArray(rs, rs.get_bs_class(<span class="string">'[Ljava/lang/String;'</span>),(rs.init_string(f) <span class="keyword">for</span> f <span class="keyword">in</span> files))
        o <span class="string">'rename0(Ljava/io/File;Ljava/io/File;)Z'</span>, (rs, _<span class="keyword">this</span>, file1, file2) -&gt;
            file1path = (file1.get_field rs, <span class="string">'Ljava/io/File;path'</span>).jvm2js_str()
            file2path = (file2.get_field rs, <span class="string">'Ljava/io/File;path'</span>).jvm2js_str()
            rs.async_op (resume_cb) -&gt;
              fs.rename file1path, file2path, (err) -&gt;
                resume_cb(<span class="keyword">if</span> err? <span class="keyword">then</span> <span class="literal">false</span> <span class="keyword">else</span> <span class="literal">true</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>o &#39;setLastModifiedTime(Ljava/io/File;J)Z&#39;, (rs, _this, file, time) -&gt;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        o <span class="string">'setPermission(Ljava/io/File;IZZ)Z'</span>, (rs, _<span class="keyword">this</span>, file, access, enable, owneronly) -&gt;
            filepath = (file.get_field rs, <span class="string">'Ljava/io/File;path'</span>).jvm2js_str()</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Access is equal to one of the following static fields:
<em> FileSystem.ACCESS_READ (0x04)
</em> FileSystem.ACCESS_WRITE (0x02)
* FileSystem.ACCESS_EXECUTE (0x01)
These are conveniently identical to their Unix equivalents, which
we have to convert to for Node.
XXX: Currently assuming that the above assumption holds across JCLs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> owneronly</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Shift it 6 bits over into the &#39;owner&#39; region of the access mode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              access &lt;&lt;= <span class="number">6</span>
            <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Clone it into the &#39;owner&#39; and &#39;group&#39; regions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              access |= (access &lt;&lt; <span class="number">6</span>) | (access &lt;&lt; <span class="number">3</span>)

            <span class="keyword">if</span> <span class="keyword">not</span> enable</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Do an invert and we&#39;ll AND rather than OR.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              access = ~access</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Returns true on success, false on failure.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            rs.async_op (resume_cb) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Fetch existing permissions on file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              stat_file filepath, (stats) -&gt;
                <span class="keyword">unless</span> stats?
                  resume_cb <span class="literal">false</span>
                <span class="keyword">else</span>
                  existing_access = stats.mode</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Apply mask.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  access = <span class="keyword">if</span> enable <span class="keyword">then</span> existing_access | access <span class="keyword">else</span> existing_access &amp; access</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Set new permissions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  fs.chmod filepath, access, (err) -&gt;
                    resume_cb(<span class="keyword">if</span> err? <span class="keyword">then</span> <span class="literal">false</span> <span class="keyword">else</span> <span class="literal">true</span>)
        o <span class="string">'setReadOnly(Ljava/io/File;)Z'</span>, (rs, _<span class="keyword">this</span>, file) -&gt;
            filepath = (file.get_field rs, <span class="string">'Ljava/io/File;path'</span>).jvm2js_str()</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>We&#39;ll be unsetting write permissions.
Leading 0o indicates octal.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            mask = ~(<span class="number">0</span>o222)
            rs.async_op (resume_cb) -&gt;
              stat_file filepath, (stats) -&gt;
                <span class="keyword">unless</span> stats?
                  resume_cb <span class="literal">false</span>
                <span class="keyword">else</span>
                  fs.chmod filepath, (stats.mode &amp; mask), (err) -&gt;
                    resume_cb(<span class="keyword">if</span> err? <span class="keyword">then</span> <span class="literal">false</span> <span class="keyword">else</span> <span class="literal">true</span>)
      ]
    util:
      concurrent:
        atomic:
          AtomicLong: [
            o <span class="string">'VMSupportsCS8()Z'</span>, -&gt; <span class="literal">true</span>
          ]
      jar:
        JarFile: [
          o <span class="string">'getMetaInfEntryNames()[L!/lang/String;'</span>, (rs) -&gt; <span class="literal">null</span>  <span class="comment"># we don't do verification</span>
        ]
      ResourceBundle: [
        o <span class="string">'getClassContext()[L!/lang/Class;'</span>, (rs) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>XXX should walk up the meta_stack and fill in the array properly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">new</span> JavaArray rs, rs.get_bs_class(<span class="string">'[Ljava/lang/Class;'</span>), [<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>]
      ]
      TimeZone: [
        o <span class="string">'getSystemTimeZoneID(L!/lang/String;L!/lang/String;)L!/lang/String;'</span>, (rs, java_home, country) -&gt;
            rs.init_string <span class="string">'GMT'</span> <span class="comment"># XXX not sure what the local value is</span>
        o <span class="string">'getSystemGMTOffsetID()L!/lang/String;'</span>, (rs) -&gt;
            <span class="literal">null</span> <span class="comment"># XXX may not be correct</span>
      ]
  sun:
    management:
      VMManagementImpl: [
        o <span class="string">'getStartupTime()J'</span>, (rs) -&gt; rs.startup_time
        o <span class="string">'getVersion0()Ljava/lang/String;'</span>, (rs) -&gt; rs.init_string <span class="string">"1.2"</span>, <span class="literal">true</span>
        o <span class="string">'initOptionalSupportFields()V'</span>, (rs) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>set everything to false</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            field_names = [ <span class="string">'compTimeMonitoringSupport'</span>, <span class="string">'threadContentionMonitoringSupport'</span>,
              <span class="string">'currentThreadCpuTimeSupport'</span>, <span class="string">'otherThreadCpuTimeSupport'</span>,
              <span class="string">'bootClassPathSupport'</span>, <span class="string">'objectMonitorUsageSupport'</span>, <span class="string">'synchronizerUsageSupport'</span> ]
            vm_management_impl = rs.get_bs_class <span class="string">'Lsun/management/VMManagementImpl;'</span>
            <span class="keyword">for</span> name <span class="keyword">in</span> field_names
              vm_management_impl.static_put rs, name, <span class="number">0</span>
        o <span class="string">'isThreadAllocatedMemoryEnabled()Z'</span>, -&gt; <span class="literal">false</span>
        o <span class="string">'isThreadContentionMonitoringEnabled()Z'</span>, -&gt; <span class="literal">false</span>
        o <span class="string">'isThreadCpuTimeEnabled()Z'</span>, -&gt; <span class="literal">false</span>
        o <span class="string">'getAvailableProcessors()I'</span>, -&gt; <span class="number">1</span>
        o <span class="string">'getProcessId()I'</span>, -&gt; <span class="number">1</span>
      ]
      MemoryImpl: [
        o <span class="string">'getMemoryManagers0()[Ljava/lang/management/MemoryManagerMXBean;'</span>, (rs) -&gt;
            <span class="keyword">new</span> JavaArray rs, rs.get_bs_class(<span class="string">'[Lsun/management/MemoryManagerImpl;'</span>), [] <span class="comment"># XXX may want to revisit this 'NOP'</span>
        o <span class="string">'getMemoryPools0()[Ljava/lang/management/MemoryPoolMXBean;'</span>, (rs) -&gt;
            <span class="keyword">new</span> JavaArray rs, rs.get_bs_class(<span class="string">'[Lsun/management/MemoryPoolImpl;'</span>), [] <span class="comment"># XXX may want to revisit this 'NOP'</span>
      ]
    misc:
      VM: [
        o <span class="string">'initialize()V'</span>, (rs) -&gt;
            vm_cls = rs.get_bs_class <span class="string">'Lsun/misc/VM;'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>this only applies to Java 7</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> <span class="keyword">unless</span> vm_cls.major_version &gt;= <span class="number">51</span></pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>hack! make savedProps refer to the system props</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            sys_cls = rs.get_bs_class(<span class="string">'Ljava/lang/System;'</span>)
            props = sys_cls.static_get rs, <span class="string">'props'</span>
            vm_cls = rs.get_bs_class(<span class="string">'Lsun/misc/VM;'</span>)
            vm_cls.static_put <span class="string">'savedProps'</span>, props
      ]</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>TODO: Go down the rabbit hole and create a fast heap implementation
in JavaScript -- with and without typed arrays.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      Unsafe: [
        o <span class="string">'addressSize()I'</span>, (rs, _<span class="keyword">this</span>) -&gt; <span class="number">4</span> <span class="comment"># either 4 or 8</span>
        o <span class="string">'allocateInstance(Ljava/lang/Class;)Ljava/lang/Object;'</span>, (rs, _<span class="keyword">this</span>, cls) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>This can trigger class initialization, so check if the class is
initialized.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            cls = cls.$cls
            <span class="keyword">if</span> cls.is_initialized(rs)
              <span class="keyword">return</span> <span class="keyword">new</span> JavaObject rs, cls
            <span class="keyword">else</span>
              rs.async_op (resume_cb, except_cb) -&gt;
                cls.loader.initialize_class rs, cls.get_type(), (-&gt;resume_cb(<span class="keyword">new</span> JavaObject rs, cls)), except_cb
        o <span class="string">'allocateMemory(J)J'</span>, (rs, _<span class="keyword">this</span>, size) -&gt;
            next_addr = util.last(rs.mem_start_addrs)
            <span class="keyword">if</span> DataView?
              rs.mem_blocks[next_addr] = <span class="keyword">new</span> DataView <span class="keyword">new</span> ArrayBuffer size
            <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>1 byte per block. Wasteful, terrible, etc... but good for now.
XXX: Stash allocation size here. Please hate me.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              rs.mem_blocks[next_addr] = size
              next_addr += <span class="number">1</span>
              <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..size] <span class="keyword">by</span> <span class="number">1</span>
                rs.mem_blocks[next_addr+i] = <span class="number">0</span>

            rs.mem_start_addrs.push(next_addr + size)
            <span class="keyword">return</span> gLong.fromNumber(next_addr)
        o <span class="string">'copyMemory(Ljava/lang/Object;JLjava/lang/Object;JJ)V'</span>, (rs, _<span class="keyword">this</span>, src_base, src_offset, dest_base, dest_offset, num_bytes) -&gt;
            unsafe_memcpy rs, src_base, src_offset, dest_base, dest_offset, num_bytes
        o <span class="string">'setMemory(JJB)V'</span>, (rs, _<span class="keyword">this</span>, address, bytes, value) -&gt;
            block_addr = rs.block_addr(address)
            <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..bytes] <span class="keyword">by</span> <span class="number">1</span>
              <span class="keyword">if</span> DataView?
                rs.mem_blocks[block_addr].setInt8(i, value)
              <span class="keyword">else</span>
                rs.mem_blocks[block_addr+i] = value
            <span class="keyword">return</span>
        o <span class="string">'freeMemory(J)V'</span>, (rs, _<span class="keyword">this</span>, address) -&gt;
            <span class="keyword">if</span> DataView?
              <span class="keyword">delete</span> rs.mem_blocks[address.toNumber()]
            <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>XXX: Size will be just before address.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              address = address.toNumber()
              num_blocks = rs.mem_blocks[address-<span class="number">1</span>]
              <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..num_blocks] <span class="keyword">by</span> <span class="number">1</span>
                <span class="keyword">delete</span> rs.mem_blocks[address+i]
              <span class="keyword">delete</span> rs.mem_blocks[address-<span class="number">1</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Restore to the actual start addr where size was.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              address = address-<span class="number">1</span>
            rs.mem_start_addrs.splice(rs.mem_start_addrs.indexOf(address), <span class="number">1</span>)
        o <span class="string">'putLong(JJ)V'</span>, (rs, _<span class="keyword">this</span>, address, value) -&gt;
            block_addr = rs.block_addr(address)
            offset = address - block_addr</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>little endian</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> DataView?
              rs.mem_blocks[block_addr].setInt32(offset, value.getLowBits(), <span class="literal">true</span>)
              rs.mem_blocks[block_addr].setInt32(offset + <span class="number">4</span>, value.getHighBits, <span class="literal">true</span>)
            <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Break up into 8 bytes. Hurray!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="function"><span class="title">store_word</span></span> = (rs_, address, word) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Little endian</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                rs_.mem_blocks[address] = word &amp; <span class="number">0xFF</span>
                rs_.mem_blocks[address+<span class="number">1</span>] = (word &gt;&gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>
                rs_.mem_blocks[address+<span class="number">2</span>] = (word &gt;&gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>
                rs_.mem_blocks[address+<span class="number">3</span>] = (word &gt;&gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>

              store_word(rs, address, value.getLowBits())
              store_word(rs, address+<span class="number">4</span>, value.getHighBits())
            <span class="keyword">return</span>
        o <span class="string">'getByte(J)B'</span>, (rs, _<span class="keyword">this</span>, address) -&gt;
            block_addr = rs.block_addr(address)
            <span class="keyword">if</span> DataView?
              <span class="keyword">return</span> rs.mem_blocks[block_addr].getInt8(address - block_addr)
            <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>Blocks are bytes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="keyword">return</span> rs.mem_blocks[block_addr]
        o <span class="string">'arrayBaseOffset(Ljava/lang/Class;)I'</span>, (rs, _<span class="keyword">this</span>, cls) -&gt; <span class="number">0</span>
        o <span class="string">'arrayIndexScale(Ljava/lang/Class;)I'</span>, (rs, _<span class="keyword">this</span>, cls) -&gt; <span class="number">1</span>
        o <span class="string">'compareAndSwapObject(Ljava/lang/Object;JLjava/lang/Object;Ljava/lang/Object;)Z'</span>, unsafe_compare_and_swap
        o <span class="string">'compareAndSwapInt(Ljava/lang/Object;JII)Z'</span>, unsafe_compare_and_swap
        o <span class="string">'compareAndSwapLong(Ljava/lang/Object;JJJ)Z'</span>, unsafe_compare_and_swap
        o <span class="string">'ensureClassInitialized(Ljava/lang/Class;)V'</span>, (rs,_<span class="keyword">this</span>,cls) -&gt;
            rs.async_op (resume_cb, except_cb) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>We modify resume_cb since this is a void function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              cls.$cls.loader.initialize_class rs, cls.$cls.get_type(), (()-&gt;resume_cb()), except_cb
        o <span class="string">'staticFieldOffset(Ljava/lang/reflect/Field;)J'</span>, (rs,_<span class="keyword">this</span>,field) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>we technically return a long, but it immediately gets casted to an int
hack: encode both the class and slot information in an integer
  this may cause collisions, but it seems to work ok</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            jco = field.get_field rs, <span class="string">'Ljava/lang/reflect/Field;clazz'</span>
            slot = field.get_field rs, <span class="string">'Ljava/lang/reflect/Field;slot'</span>
            gLong.fromNumber(slot + jco.ref)
        o <span class="string">'objectFieldOffset(Ljava/lang/reflect/Field;)J'</span>, (rs,_<span class="keyword">this</span>,field) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>see note about staticFieldOffset</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            jco = field.get_field rs, <span class="string">'Ljava/lang/reflect/Field;clazz'</span>
            slot = field.get_field rs, <span class="string">'Ljava/lang/reflect/Field;slot'</span>
            gLong.fromNumber(slot + jco.ref)
        o <span class="string">'staticFieldBase(Ljava/lang/reflect/Field;)Ljava/lang/Object;'</span>, (rs,_<span class="keyword">this</span>,field) -&gt;
            cls = field.get_field rs, <span class="string">'Ljava/lang/reflect/Field;clazz'</span>
            <span class="keyword">new</span> JavaObject rs, cls.$cls
        o <span class="string">'getBoolean(Ljava/lang/Object;J)Z'</span>, (rs, _<span class="keyword">this</span>, obj, offset) -&gt;
            obj.get_field_from_offset rs, offset
        o <span class="string">'getBooleanVolatile(Ljava/lang/Object;J)Z'</span>, (rs, _<span class="keyword">this</span>, obj, offset) -&gt;
            obj.get_field_from_offset rs, offset
        o <span class="string">'getDouble(Ljava/lang/Object;J)D'</span>, (rs, _<span class="keyword">this</span>, obj, offset) -&gt;
            obj.get_field_from_offset rs, offset
        o <span class="string">'getDoubleVolatile(Ljava/lang/Object;J)D'</span>, (rs, _<span class="keyword">this</span>, obj, offset) -&gt;
            obj.get_field_from_offset rs, offset
        o <span class="string">'getFloat(Ljava/lang/Object;J)F'</span>, (rs, _<span class="keyword">this</span>, obj, offset) -&gt;
            obj.get_field_from_offset rs, offset
        o <span class="string">'getFloatVolatile(Ljava/lang/Object;J)F'</span>, (rs, _<span class="keyword">this</span>, obj, offset) -&gt;
            obj.get_field_from_offset rs, offset
        o <span class="string">'getInt(Ljava/lang/Object;J)I'</span>, (rs, _<span class="keyword">this</span>, obj, offset) -&gt;
            obj.get_field_from_offset rs, offset
        o <span class="string">'getIntVolatile(Ljava/lang/Object;J)I'</span>, (rs, _<span class="keyword">this</span>, obj, offset) -&gt;
            obj.get_field_from_offset rs, offset
        o <span class="string">'getLong(Ljava/lang/Object;J)J'</span>, (rs, _<span class="keyword">this</span>, obj, offset) -&gt;
            obj.get_field_from_offset rs, offset
        o <span class="string">'getLongVolatile(Ljava/lang/Object;J)J'</span>, (rs, _<span class="keyword">this</span>, obj, offset) -&gt;
            obj.get_field_from_offset rs, offset
        o <span class="string">'getShort(Ljava/lang/Object;J)S'</span>, (rs, _<span class="keyword">this</span>, obj, offset) -&gt;
            obj.get_field_from_offset rs, offset
        o <span class="string">'getShortVolatile(Ljava/lang/Object;J)S'</span>, (rs, _<span class="keyword">this</span>, obj, offset) -&gt;
            obj.get_field_from_offset rs, offset
        o <span class="string">'getObject(Ljava/lang/Object;J)Ljava/lang/Object;'</span>, (rs,_<span class="keyword">this</span>,obj,offset) -&gt;
            obj.get_field_from_offset rs, offset
        o <span class="string">'getObjectVolatile(Ljava/lang/Object;J)Ljava/lang/Object;'</span>, (rs,_<span class="keyword">this</span>,obj,offset) -&gt;
            obj.get_field_from_offset rs, offset
        o <span class="string">'putDouble(Ljava/lang/Object;JD)V'</span>, (rs,_<span class="keyword">this</span>,obj,offset,new_value) -&gt;
            obj.set_field_from_offset rs, offset, new_value
        o <span class="string">'putInt(Ljava/lang/Object;JI)V'</span>, (rs,_<span class="keyword">this</span>,obj,offset,new_value) -&gt;
            obj.set_field_from_offset rs, offset, new_value
        o <span class="string">'putObject(Ljava/lang/Object;JLjava/lang/Object;)V'</span>, (rs,_<span class="keyword">this</span>,obj,offset,new_obj) -&gt;
            obj.set_field_from_offset rs, offset, new_obj
        o <span class="string">'putObjectVolatile(Ljava/lang/Object;JLjava/lang/Object;)V'</span>, (rs,_<span class="keyword">this</span>,obj,offset,new_obj) -&gt;
            obj.set_field_from_offset rs, offset, new_obj
        o <span class="string">'putOrderedObject(Ljava/lang/Object;JLjava/lang/Object;)V'</span>, (rs,_<span class="keyword">this</span>,obj,offset,new_obj) -&gt;
            obj.set_field_from_offset rs, offset, new_obj
        o <span class="string">'defineClass(Ljava/lang/String;[BIILjava/lang/ClassLoader;Ljava/security/ProtectionDomain;)Ljava/lang/Class;'</span>, (rs, _<span class="keyword">this</span>, name, bytes, offset, len, loader, pd) -&gt;
            rs.async_op (success_cb, except_cb) -&gt;
              native_define_class rs, name, bytes, offset, len, get_cl_from_jclo(rs, loader), success_cb, except_cb
        o <span class="string">'pageSize()I'</span>, (rs) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>Keep this in sync with sun/nio/ch/FileChannelImpl/initIDs for Mac
JCL compatibility.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="number">1024</span>
      ]
    nio:
      ch:
        FileChannelImpl: [</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>this poorly-named method actually specifies the page size for mmap
This is the Mac name for sun/misc/Unsafe::pageSize. Apparently they
wanted to ensure page sizes can be &gt; 2GB...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          o <span class="string">'initIDs()J'</span>, (rs) -&gt; gLong.fromNumber(<span class="number">1024</span>)  <span class="comment"># arbitrary</span>
        ]
        FileDispatcher: [
          o <span class="string">'init()V'</span>, (rs) -&gt; <span class="comment"># NOP</span>
          o <span class="string">'read0(Ljava/io/FileDescriptor;JI)I'</span>, (rs, fd_obj, address, len) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>this is the same as the .$file attribute on FileInputStream</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            fd = fd_obj.get_field rs, <span class="string">'Ljava/io/FileDescriptor;fd'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>read upto len bytes and store into mmap&#39;d buffer at address</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            block_addr = rs.block_addr(address)
            buf = <span class="keyword">new</span> Buffer len
            bytes_read = fs.readSync(fd, buf, <span class="number">0</span>, len)
            <span class="keyword">if</span> DataView?
              <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..bytes_read] <span class="keyword">by</span> <span class="number">1</span>
                rs.mem_blocks[block_addr].setInt8(i, buf.readInt8(i))
            <span class="keyword">else</span>
              <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..bytes_read] <span class="keyword">by</span> <span class="number">1</span>
                rs.mem_blocks[block_addr+i] = buf.readInt8(i)
            <span class="keyword">return</span> bytes_read
          o <span class="string">'preClose0(Ljava/io/FileDescriptor;)V'</span>, (rs, fd_obj) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>NOP, I think the actual fs.close is called later. If not, NBD.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ]
        NativeThread: [
          o <span class="string">"init()V"</span>, (rs) -&gt; <span class="comment"># NOP</span>
          o <span class="string">"current()J"</span>, (rs) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>-1 means that we do not require signaling according to the
docs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              gLong.fromNumber(-<span class="number">1</span>)
        ]
    reflect:
      ConstantPool: [
        o <span class="string">'getLongAt0(Ljava/lang/Object;I)J'</span>, (rs, _<span class="keyword">this</span>, cp, idx) -&gt;
            cp.get(idx).value
        o <span class="string">'getUTF8At0(Ljava/lang/Object;I)Ljava/lang/String;'</span>, (rs, _<span class="keyword">this</span>, cp, idx) -&gt;
            rs.init_string cp.get(idx).value
      ]
      NativeMethodAccessorImpl: [
        o <span class="string">'invoke0(Ljava/lang/reflect/Method;Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;'</span>, (rs,m,obj,params) -&gt;
            cls = m.get_field rs, <span class="string">'Ljava/lang/reflect/Method;clazz'</span>
            slot = m.get_field rs, <span class="string">'Ljava/lang/reflect/Method;slot'</span>
            rs.async_op (resume_cb, except_cb) -&gt;
              cls.$cls.loader.initialize_class rs, cls.$cls.get_type(), ((cls_obj) -&gt;
                method = (method <span class="keyword">for</span> sig, method <span class="keyword">of</span> cls_obj.get_methods() <span class="keyword">when</span> method.idx <span class="keyword">is</span> slot)[<span class="number">0</span>]
                my_sf = rs.curr_frame()
                rs.push obj <span class="keyword">unless</span> method.access_flags.static</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>we don&#39;t get unboxing for free anymore, so we have to do it ourselves</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                i = <span class="number">0</span>
                <span class="keyword">for</span> p_type <span class="keyword">in</span> method.param_types
                  p = params.array[i++]
                  <span class="keyword">if</span> p_type <span class="keyword">in</span> [<span class="string">'J'</span>,<span class="string">'D'</span>]  <span class="comment"># cat 2 primitives</span>
                    <span class="keyword">if</span> p?.ref?
                      primitive_value = p.get_field rs, p.cls.get_type()+<span class="string">'value'</span>
                      rs.push2 primitive_value, <span class="literal">null</span>
                    <span class="keyword">else</span>
                      rs.push2 p, <span class="literal">null</span>
                      i++  <span class="comment"># skip past the null spacer</span>
                  <span class="keyword">else</span> <span class="keyword">if</span> util.is_primitive_type(p_type)  <span class="comment"># any other primitive</span>
                    <span class="keyword">if</span> p?.ref?
                      primitive_value = p.get_field rs, p.cls.get_type()+<span class="string">'value'</span>
                      rs.push primitive_value
                    <span class="keyword">else</span>
                      rs.push p
                  <span class="keyword">else</span>
                    rs.push p</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>Reenter the RuntimeState loop, which should run our new StackFrame.
XXX: We use except_cb because it just replaces the runner function of the
current frame. We need a better story for calling Java threads through
native functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                except_cb -&gt;
                  method.setup_stack(rs)</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>Overwrite my runner.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  my_sf.<span class="function"><span class="title">runner</span></span> = -&gt;
                    ret_type = m.get_field rs, <span class="string">'Ljava/lang/reflect/Method;returnType'</span>
                    descriptor = ret_type.$cls.get_type()
                    rv = rs.pop()</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>pop again if it&#39;s a category 2 primitive type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    rv = rs.pop() <span class="keyword">if</span> descriptor <span class="keyword">in</span> [<span class="string">'J'</span>,<span class="string">'D'</span>]
                    rs.meta_stack().pop()</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>wrap up primitives in their Object box</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> util.is_primitive_type(descriptor) <span class="keyword">and</span> descriptor != <span class="string">'V'</span>
                      rs.push ret_type.$cls.create_wrapper_object(rs, rv)
                    <span class="keyword">else</span>
                      rs.push rv
              ), except_cb
      ]
      NativeConstructorAccessorImpl: [
        o <span class="string">'newInstance0(Ljava/lang/reflect/Constructor;[Ljava/lang/Object;)Ljava/lang/Object;'</span>, (rs,m,params) -&gt;
            cls = m.get_field rs, <span class="string">'Ljava/lang/reflect/Constructor;clazz'</span>
            slot = m.get_field rs, <span class="string">'Ljava/lang/reflect/Constructor;slot'</span>
            rs.async_op (resume_cb, except_cb) -&gt;
              cls.$cls.loader.initialize_class rs, cls.$cls.get_type(), ((cls_obj)-&gt;
                method = (method <span class="keyword">for</span> sig, method <span class="keyword">of</span> cls_obj.get_methods() <span class="keyword">when</span> method.idx <span class="keyword">is</span> slot)[<span class="number">0</span>]
                my_sf = rs.curr_frame()
                obj = <span class="keyword">new</span> JavaObject rs, cls_obj
                rs.push obj
                rs.push_array(params.array) <span class="keyword">if</span> params?</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>Reenter the RuntimeState loop, which should run our new StackFrame.
XXX: We use except_cb because it just replaces the runner function of the
current frame. We need a better story for calling Java threads through
native functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                except_cb -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>Push the constructor&#39;s frame onto the stack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  method.setup_stack(rs)</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>Overwrite my runner.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  my_sf.<span class="function"><span class="title">runner</span></span> = -&gt;
                    rs.meta_stack().pop()
                    rs.push obj
              ), except_cb
      ]
      Reflection: [
        o <span class="string">'getCallerClass(I)Ljava/lang/Class;'</span>, (rs, frames_to_skip) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>TODO: disregard frames assoc. with java.lang.reflect.Method.invoke() and its implementation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            caller = rs.meta_stack().get_caller(frames_to_skip)
            cls = caller.method.cls
            <span class="keyword">return</span> cls.get_class_object(rs)
        o <span class="string">'getClassAccessFlags(Ljava/lang/Class;)I'</span>, (rs, class_obj) -&gt;
            class_obj.$cls.access_byte
      ]

<span class="function"><span class="title">flatten_pkg</span></span> = (pkg) -&gt;
  result = {}
  pkg_name_arr = []
  <span class="function"><span class="title">rec_flatten</span></span> = (pkg) -&gt;
    <span class="keyword">for</span> pkg_name, inner_pkg <span class="keyword">of</span> pkg
      pkg_name_arr.push pkg_name
      <span class="keyword">if</span> inner_pkg <span class="keyword">instanceof</span> Array
        full_pkg_name = pkg_name_arr.join <span class="string">'/'</span>
        <span class="keyword">for</span> method <span class="keyword">in</span> inner_pkg
          {fn_name, fn} = method</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>expand out the &#39;!&#39;s in the method names</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          fn_name = fn_name.replace <span class="regexp">/!|;/g</span>, <span class="keyword">do</span> -&gt;
            depth = <span class="number">0</span>
            (c) -&gt;
              <span class="keyword">if</span> c == <span class="string">'!'</span> <span class="keyword">then</span> pkg_name_arr[depth++]
              <span class="keyword">else</span> <span class="keyword">if</span> c == <span class="string">';'</span> <span class="keyword">then</span> depth = <span class="number">0</span>; c
              <span class="keyword">else</span> c
          full_name = <span class="string">"L<span class="subst">#{full_pkg_name}</span>;::<span class="subst">#{fn_name}</span>"</span>
          result[full_name] = fn
      <span class="keyword">else</span>
        flattened_inner = rec_flatten inner_pkg
      pkg_name_arr.pop pkg_name
  rec_flatten pkg
  result

root.trapped_methods = flatten_pkg trapped_methods
root.native_methods = flatten_pkg native_methods</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
